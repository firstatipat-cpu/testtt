<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE Health App (LIFF)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <!-- ‚òÖ‚òÖ‚òÖ NEW: Tone.js for Audio ‚òÖ‚òÖ‚òÖ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+Thai:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Apply Thai font primarily */
        body { font-family: 'Noto Sans Thai', 'Inter', sans-serif; }
        /* Simple modal styles */
        .modal { display: none; /* Hidden by default */ }
        .modal.is-open { display: flex; /* Shown when class is added */ opacity: 1; pointer-events: auto; }
        .modal.is-closing { opacity: 0; pointer-events: none; } /* State for closing animation */
        .modal .modal-content { transform: scale(0.95); transition: transform 0.2s ease-out, opacity 0.2s ease-out; } /* Closing state */
        .modal.is-open .modal-content { transform: scale(1); } /* Opening state */
        /* Add custom gradient for buttons based on React components */
        .bg-gradient-pink-rose { background-image: linear-gradient(to bottom right, #EC4899, #F43F5E); } /* pink-500 to rose-500 */
        .hover\:bg-gradient-pink-rose-dark:hover { background-image: linear-gradient(to bottom right, #DB2777, #E11D48); } /* pink-600 to rose-600 */
        .bg-gradient-indigo-purple { background-image: linear-gradient(to bottom right, #6366F1, #A855F7); } /* indigo-500 to purple-500 */
        .hover\:bg-gradient-indigo-purple-dark:hover { background-image: linear-gradient(to bottom right, #4F46E5, #9333EA); } /* indigo-600 to purple-600 */
        /* Spinner styles */
        .spinner {
          border: 4px solid rgba(0, 0, 0, 0.1);
          width: 36px;
          height: 36px;
          border-radius: 50%;
          border-left-color: #059669; /* green-600 */
          animation: spin 1s linear infinite;
        }
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
        /* Style for active duration button */
        .duration-button-active {
            background-color: #4F46E5 !important; /* indigo-600 */
            color: white !important;
            border-color: transparent !important;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen">

    <div class="container mx-auto px-4 py-6 max-w-md">

        <!-- Loading State -->
        <div id="loadingState" class="flex flex-col items-center justify-center min-h-[70vh] text-center p-10">
            <div class="spinner mb-4"></div>
            <p class="text-lg text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
        </div>

        <!-- Login State -->
        <div id="loginState" class="hidden text-center p-10 bg-white rounded-xl shadow-lg mt-10">
            <h1 class="text-2xl font-semibold text-green-600 mb-2">LINE Health App</h1>
            <p class="text-gray-600 mb-6">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏ö‡∏±‡∏ç‡∏ä‡∏µ LINE ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
            <button id="btnLogin" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition duration-200">
                ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ LINE
            </button>
        </div>

        <!-- App State (Logged In) -->
        <div id="appState" class="hidden space-y-6">

            <!-- Header -->
            <div class="mb-4"> <!-- Reduced bottom margin -->
                <h1 class="text-2xl font-semibold text-green-600 mb-1">LINE Health App</h1>
                <p class="text-gray-600">Track your health with Google Fit</p>
            </div>

            <!-- NEW: AI Greeting Message -->
            <div id="greetingSection" class="bg-white rounded-xl p-4 shadow text-center mb-6">
                <p id="greetingMessage" class="text-gray-700">...</p>
            </div>
            <!-- END NEW SECTION -->


            <!-- LINE Profile (from LineProfile.tsx) -->
            <div id="profileSection" class="bg-white rounded-2xl p-6 shadow-lg">
                 <div class="flex items-center gap-4">
                    <!-- Image with Fallback Placeholder -->
                    <img id="userPicture" class="w-20 h-20 rounded-full border-4 border-green-100 object-cover bg-gray-100 flex-shrink-0" src="https://placehold.co/80x80/E5E7EB/A1A1AA?text=?" alt="User Picture" onerror="this.onerror=null; this.src='https://placehold.co/80x80/E5E7EB/A1A1AA?text=Err';">
                    <div class="flex-1 min-w-0"> <!-- Added min-w-0 for text truncation -->
                        <h2 id="displayName" class="text-xl font-semibold text-gray-900 mb-1 truncate">...</h2>
                        <!-- Status message can be added here if needed -->
                        <p class="text-xs text-gray-500 break-all">
                             ID: <span id="userId">...</span>
                        </p>
                    </div>
                    <!-- LINE Icon -->
                    <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center flex-shrink-0">
                        <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                            <!-- SVG Path for LINE icon -->
                            <path d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63h2.386c.346 0 .627.285.627.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.105.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345 0 .63.285.63.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63.346 0 .628.285.628.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.63 0 .344-.282.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314"/>
                        </svg>
                    </div>
                 </div>
            </div>

            <!-- Google Fit Connection (Matches App.tsx design) -->
            <div id="connectSection" class="mb-6">
                <button id="btnConnectHealth" class="w-full bg-white rounded-xl p-4 shadow-md hover:shadow-lg transition-shadow flex items-center justify-center gap-3 text-gray-700 font-medium disabled:opacity-70 disabled:cursor-not-allowed">
                    <!-- Google Fit Shield Icon SVG -->
                    <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                         <path d="M12 2L2 7V17C2 19.7614 6.47715 22 12 22C17.5228 22 22 19.7614 22 17V7L12 2Z" fill="#4285F4"/>
                         <path d="M10.0001 16L6.00006 12L7.41006 10.59L10.0001 13.17L16.5901 6.58L18.0001 8L10.0001 16Z" fill="white"/>
                    </svg>
                    <span id="connectText">Connect to Google Fit</span>
                    <!-- Pulse added for connected state -->
                    <div id="connectPulse" class="w-3 h-3 bg-green-500 rounded-full animate-pulse hidden ml-2 flex-shrink-0"></div>
                </button>
                <p id="connectSubtext" class="text-xs text-gray-500 mt-2 text-center"></p>
            </div>

            <!-- Health Dashboard (from HealthDashboard.tsx) -->
            <div id="dashboardSection" class="space-y-4">
                 <div class="flex items-center justify-between mb-2">
                    <h3 class="text-lg font-semibold text-gray-900">Your Health Metrics</h3>
                    <span id="lastSync" class="text-gray-400 text-xs"></span>
                </div>

                <!-- Steps Card -->
                <div class="bg-white rounded-xl p-6 shadow-md border-0 hover:shadow-lg transition-shadow">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-4 min-w-0"> <!-- Added min-w-0 -->
                            <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center flex-shrink-0">
                                <!-- Activity Icon (Bolt) -->
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                            </div>
                            <div class="min-w-0"> <!-- Added min-w-0 -->
                                <p class="text-sm text-gray-500 truncate">Steps Today</p>
                                <p id="stepsData" class="text-xl font-semibold text-gray-900 truncate">...</p>
                            </div>
                        </div>
                        <div class="text-right flex-shrink-0 ml-2">
                            <div id="stepsGoalPercent" class="text-blue-600 text-sm font-medium">--%</div>
                            <div class="text-gray-400 text-xs">of 10K goal</div>
                        </div>
                    </div>
                    <div class="bg-gray-100 rounded-full h-2 overflow-hidden">
                        <div id="stepsProgressBar" class="bg-blue-500 h-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Heart Rate Card -->
                 <div class="bg-white rounded-xl p-6 shadow-md border-0 hover:shadow-lg transition-shadow">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4 min-w-0">
                            <div class="w-12 h-12 bg-red-100 rounded-xl flex items-center justify-center flex-shrink-0">
                                <!-- Heart Icon -->
                                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 010 6.364L12 20.364l7.682-7.682a4.5 4.5 0 01-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 010 6.364z"></path></svg>
                            </div>
                            <div class="min-w-0">
                                <p class="text-sm text-gray-500 truncate">Heart Rate (Avg)</p>
                                <p id="hrData" class="text-xl font-semibold text-gray-900 truncate">... <span class="text-xs font-normal">BPM</span></p>
                            </div>
                        </div>
                        <div id="hrStatus" class="flex items-center gap-2 flex-shrink-0 ml-2">
                             <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
                            <span class="text-gray-500 text-sm font-medium">--</span>
                        </div>
                    </div>
                </div>

                <!-- BMI Card -->
                 <div class="bg-white rounded-xl p-6 shadow-md border-0 hover:shadow-lg transition-shadow">
                     <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4 min-w-0">
                            <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center flex-shrink-0">
                                <!-- Scale Icon -->
                                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3-1m0 0l3 1m-3-1v11m6-11l-3-1m0 0l-3 1m3-1v11m6-11l3 1m0 0l-3 9a5.002 5.002 0 01-6.001 0M18 7l3-1m0 0l-3 1m-6-4a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </div>
                            <div class="min-w-0">
                                <p class="text-sm text-gray-500 truncate">Body Mass Index</p>
                                <p id="bmiData" class="text-xl font-semibold text-gray-900 truncate">...</p>
                            </div>
                        </div>
                        <div class="text-right flex-shrink-0 ml-2">
                             <span id="bmiCategory" class="text-gray-500 font-medium text-sm">--</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons (from ActionButtons.tsx) -->
            <div id="actionButtons" class="grid grid-cols-2 gap-4 pt-4">
                <button id="btnMedication" class="h-auto py-6 flex flex-col items-center justify-center gap-2 bg-gradient-pink-rose hover:bg-gradient-pink-rose-dark shadow-lg text-white rounded-xl transition duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-500">
                    <!-- Pill Icon -->
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.368-.825a2 2 0 01-1.022-.547L12.572 11h-1.144l-2.443 2.509a2 2 0 01-1.022.547l-2.368.825a2 2 0 00-1.022.547L3 17.25a2 2 0 002 2h14a2 2 0 002-2l-1.572-1.822zM12 2a4 4 0 014 4h-8a4 4 0 014-4z"></path></svg>
                    <span class="text-sm font-medium">Medication</span>
                </button>
                <button id="btnMeditation" class="h-auto py-6 flex flex-col items-center justify-center gap-2 bg-gradient-indigo-purple hover:bg-gradient-indigo-purple-dark shadow-lg text-white rounded-xl transition duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <!-- Brain Icon (Updated SVG for Meditation) -->
                     <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg>
                    <span class="text-sm font-medium">Meditation</span>
                </button>
            </div>

            <!-- Logout Button -->
            <button id="btnLogout" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 rounded-lg mt-4 transition duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
            </button>
        </div>
    </div>

    <!-- Modal Placeholders (Improved styling and closing logic) -->
    <!-- Medication Modal -->
    <div id="medicationModal" class="modal fixed inset-0 z-50 items-center justify-center bg-black/60 p-4 backdrop-blur-sm transition-opacity duration-200 opacity-0 pointer-events-none">
        <div class="modal-content bg-white rounded-lg p-6 max-w-sm w-full shadow-xl transition-transform duration-200">
            <div class="flex items-center gap-2 mb-4">
                 <svg class="w-5 h-5 text-pink-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.368-.825a2 2 0 01-1.022-.547L12.572 11h-1.144l-2.443 2.509a2 2 0 01-1.022.547l-2.368.825a2 2 0 00-1.022.547L3 17.25a2 2 0 002 2h14a2 2 0 002-2l-1.572-1.822zM12 2a4 4 0 014 4h-8a4 4 0 014-4z"></path></svg>
                <h2 class="text-lg font-semibold text-gray-900">Medication Reminder</h2>
            </div>
            <p class="text-gray-600 mb-6 text-sm">‡∏ï‡∏±‡πâ‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</p>
            <button onclick="closeModal('medicationModal')" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 rounded-lg text-sm font-medium transition duration-200">Close</button>
        </div>
    </div>

    <!-- ‚òÖ‚òÖ‚òÖ Meditation Modal (UPDATED with Timer & Audio) ‚òÖ‚òÖ‚òÖ -->
    <div id="meditationModal" class="modal fixed inset-0 z-50 items-center justify-center bg-black/60 p-4 backdrop-blur-sm transition-opacity duration-200 opacity-0 pointer-events-none">
         <div class="modal-content bg-white rounded-lg p-6 max-w-sm w-full shadow-xl transition-transform duration-200">
            <!-- Header -->
            <div class="flex items-center gap-2 mb-4">
                 <svg class="w-5 h-5 text-indigo-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg>
                <h2 class="text-lg font-semibold text-gray-900">Meditation Session</h2>
            </div>
            <p class="text-gray-600 mb-6 text-sm">‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏Ñ‡∏•‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏ù‡∏∂‡∏Å‡∏™‡∏°‡∏≤‡∏ò‡∏¥</p>

            <!-- Timer Display (like React component) -->
            <div class="relative mb-6">
                <div class="w-48 h-48 mx-auto relative">
                    <svg class="w-full h-full transform -rotate-90">
                        <circle cx="96" cy="96" r="88" stroke="#e5e7eb" stroke-width="8" fill="none" />
                        <circle id="meditationProgressCircle" cx="96" cy="96" r="88" stroke="url(#gradient)" stroke-width="8" fill="none" stroke-dasharray="553" stroke-dashoffset="553" <!-- Approx 2*PI*88 -->
                                stroke-linecap="round" class="transition-all duration-1000" />
                        <defs>
                            <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" stop-color="#6366f1" /> {/* indigo-500 */}
                                <stop offset="100%" stop-color="#a855f7" /> {/* purple-500 */}
                            </linearGradient>
                        </defs>
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center flex-col">
                        <span id="meditationTimeLeft" class="text-3xl font-semibold text-gray-900">5:00</span>
                        <span id="meditationStatus" class="text-gray-500 text-sm mt-1">Ready</span>
                    </div>
                </div>
            </div>

            <!-- Duration Selection -->
            <div class="space-y-2 mb-6">
                <label class="text-sm font-medium text-gray-700">Duration</label>
                <div class="grid grid-cols-4 gap-2">
                    <button data-duration="180" class="meditation-duration-btn border border-gray-300 text-gray-700 py-1 rounded-md text-sm hover:bg-gray-100 disabled:opacity-50">3m</button>
                    <button data-duration="300" class="meditation-duration-btn border border-gray-300 text-gray-700 py-1 rounded-md text-sm hover:bg-gray-100 disabled:opacity-50 duration-button-active">5m</button>
                    <button data-duration="600" class="meditation-duration-btn border border-gray-300 text-gray-700 py-1 rounded-md text-sm hover:bg-gray-100 disabled:opacity-50">10m</button>
                    <button data-duration="900" class="meditation-duration-btn border border-gray-300 text-gray-700 py-1 rounded-md text-sm hover:bg-gray-100 disabled:opacity-50">15m</button>
                </div>
            </div>

            <!-- Timer Controls -->
            <div class="flex gap-3 mb-6">
                <button id="btnMeditationTogglePlay" class="flex-1 bg-gradient-indigo-purple hover:bg-gradient-indigo-purple-dark text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center gap-2 transition duration-200">
                    <svg id="meditationPlayIcon" class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>
                    <svg id="meditationPauseIcon" class="w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd" /></svg>
                    <span id="meditationPlayText">Start</span>
                </button>
                <button id="btnMeditationReset" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition duration-200">
                     <!-- RotateCcw Icon -->
                     <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9M3.22 13.582A8.001 8.001 0 0019.418 15M20 20v-5h-.581"></path></svg>
                </button>
            </div>

            <!-- ‚òÖ‚òÖ‚òÖ NEW: Audio Controls ‚òÖ‚òÖ‚òÖ -->
            <div class="flex items-center justify-between border-t pt-4 mt-4">
                 <span class="text-sm text-gray-600">Ambient Sound</span>
                 <div class="flex items-center gap-2">
                     <button id="btnAudioTogglePlay" class="p-1 text-gray-500 hover:text-gray-700 disabled:opacity-50" title="Play/Pause Sound" disabled>
                         <svg id="audioPlayIcon" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zm.73-10.91a.75.75 0 00-1.46 0v3.82a.75.75 0 001.46 0v-3.82zM9.25 14a.75.75 0 100-1.5.75.75 0 000 1.5z"/></svg> <!-- Placeholder Play Icon -->
                         <svg id="audioPauseIcon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 011-1h1a1 1 0 110 2H8a1 1 0 01-1-1zm5 0a1 1 0 011-1h1a1 1 0 110 2h-1a1 1 0 01-1-1z"/></svg> <!-- Placeholder Pause Icon -->
                     </button>
                     <button id="btnAudioToggleMute" class="p-1 text-gray-500 hover:text-gray-700" title="Mute/Unmute">
                         <svg id="audioMuteIcon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"/></svg> <!-- Mute Icon -->
                         <svg id="audioUnmuteIcon" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v6a1 1 0 102 0V7zM7 9a1 1 0 000 2h1a1 1 0 100-2H7zm8 0a1 1 0 10-2 0v6a1 1 0 102 0V9z"/></svg> <!-- Volume Icon -->
                     </button>
                 </div>
            </div>
            <!-- ‚òÖ‚òÖ‚òÖ END NEW AUDIO ‚òÖ‚òÖ‚òÖ -->


            <!-- Close Button -->
            <button onclick="closeModal('meditationModal')" class="mt-6 w-full bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 rounded-lg text-sm font-medium transition duration-200">Close</button>
        </div>
    </div>
    <!-- END Meditation Modal -->


    <!-- JavaScript Logic (Includes AI Greeting and Meditation Audio) -->
    <script>
        // --- DOM Elements ---
        const loadingState = document.getElementById("loadingState");
        const loginState = document.getElementById("loginState");
        const appState = document.getElementById("appState");
        const btnLogin = document.getElementById("btnLogin");
        const btnLogout = document.getElementById("btnLogout");
        const btnConnectHealth = document.getElementById("btnConnectHealth");
        const userPicture = document.getElementById("userPicture");
        const displayName = document.getElementById("displayName");
        const userId = document.getElementById("userId");
        const greetingMessage = document.getElementById("greetingMessage");
        const connectText = document.getElementById("connectText");
        const connectSubtext = document.getElementById("connectSubtext");
        const connectPulse = document.getElementById("connectPulse");
        const lastSync = document.getElementById("lastSync");
        const stepsData = document.getElementById("stepsData");
        const stepsGoalPercent = document.getElementById("stepsGoalPercent");
        const stepsProgressBar = document.getElementById("stepsProgressBar");
        const hrData = document.getElementById("hrData");
        const hrStatus = document.getElementById("hrStatus");
        const bmiData = document.getElementById("bmiData");
        const bmiCategory = document.getElementById("bmiCategory");
        const btnMedication = document.getElementById("btnMedication");
        const btnMeditation = document.getElementById("btnMeditation");
        const medicationModal = document.getElementById("medicationModal");
        // Meditation Modal Elements
        const meditationModal = document.getElementById("meditationModal");
        const meditationTimeLeft = document.getElementById("meditationTimeLeft");
        const meditationStatus = document.getElementById("meditationStatus");
        const meditationProgressCircle = document.getElementById("meditationProgressCircle");
        const durationButtons = document.querySelectorAll(".meditation-duration-btn");
        const btnMeditationTogglePlay = document.getElementById("btnMeditationTogglePlay");
        const meditationPlayIcon = document.getElementById("meditationPlayIcon");
        const meditationPauseIcon = document.getElementById("meditationPauseIcon");
        const meditationPlayText = document.getElementById("meditationPlayText");
        const btnMeditationReset = document.getElementById("btnMeditationReset");
        // Audio Elements
        const btnAudioTogglePlay = document.getElementById("btnAudioTogglePlay");
        const audioPlayIcon = document.getElementById("audioPlayIcon");
        const audioPauseIcon = document.getElementById("audioPauseIcon");
        const btnAudioToggleMute = document.getElementById("btnAudioToggleMute");
        const audioMuteIcon = document.getElementById("audioMuteIcon");
        const audioUnmuteIcon = document.getElementById("audioUnmuteIcon");


        // --- Configuration ---
        const LIFF_ID = "2008337931-z1xeJb7D"; // üî∏ MUST BE YOUR LIFF ID
        const SERVER_URL = "https://sequential-seborrheal-clelia.ngrok-free.dev"; // üîó MUST BE YOUR NGROK URL

        // --- Meditation State ---
        let meditationTimerInterval = null;
        let meditationIsPlaying = false;
        let meditationTimeTotal = 300; // Default 5 minutes
        let meditationTimeRemaining = 300;

        // --- ‚òÖ‚òÖ‚òÖ NEW: Tone.js Audio State ‚òÖ‚òÖ‚òÖ ---
        let audioSynth = null; // To hold the Tone.js synth
        let audioIsPlaying = false; // Separate state for audio playback
        let audioIsMuted = false;   // Separate state for audio mute
        let isAudioContextStarted = false; // Flag to ensure AudioContext starts

        // --- UI Functions ---
        function showLoading() { /* ... (same as before) ... */ }
        function showLogin() { /* ... (same as before) ... */ }
        function showApp() { /* ... (same as before) ... */ }
        function updateConnectButton(connected, message = null) { /* ... (same as before) ... */ }
        function getBMICategory(bmi) { /* ... (same as before) ... */ }
        function getHRStatus(hr) { /* ... (same as before) ... */ }
        function showLoading() {
            loadingState.style.display = "flex";
            loginState.style.display = "none";
            appState.style.display = "none";
        }
        function showLogin() {
            loadingState.style.display = "none";
            loginState.style.display = "block";
            appState.style.display = "none";
        }
        function showApp() {
            loadingState.style.display = "none";
            loginState.style.display = "none";
            appState.style.display = "block";
        }
        function updateConnectButton(connected, message = null) {
            if (connected) {
                connectText.innerText = "Connected";
                btnConnectHealth.classList.add("bg-green-100", "text-green-700", "cursor-not-allowed");
                btnConnectHealth.classList.remove("bg-white", "hover:shadow-lg");
                btnConnectHealth.disabled = true;
                connectPulse.classList.remove("hidden");
                connectSubtext.innerText = message || `Last sync: ${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
                connectSubtext.className = "text-xs text-green-600 mt-2 text-center";
            } else {
                connectText.innerText = "Connect to Google Fit";
                btnConnectHealth.classList.remove("bg-green-100", "text-green-700", "cursor-not-allowed");
                btnConnectHealth.classList.add("bg-white", "hover:shadow-lg");
                btnConnectHealth.disabled = false;
                connectPulse.classList.add("hidden");
                connectSubtext.innerText = message || "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
                connectSubtext.className = `text-xs mt-2 text-center ${message ? 'text-red-500' : 'text-gray-500'}`;
            }
        }
        // BMI Categories (Tailwind color classes included)
        function getBMICategory(bmi) {
            if (bmi <= 0) return { text: "--", color: "text-gray-500" };
            if (bmi < 18.5) return { text: "Underweight", color: "text-blue-600" };
            if (bmi < 25) return { text: "Normal", color: "text-green-600" };
            if (bmi < 30) return { text: "Overweight", color: "text-orange-600" };
            return { text: "Obese", color: "text-red-600" };
        }
        // Heart Rate Status (Tailwind color classes included)
        function getHRStatus(hr) {
            if (hr <= 0) return { text: "--", color: "bg-gray-400", textColor: "text-gray-500" };
            if (hr < 60) return { text: "Resting", color: "bg-blue-500", textColor: "text-blue-600" };
            if (hr <= 100) return { text: "Normal", color: "bg-green-500", textColor: "text-green-600" };
            return { text: "Elevated", color: "bg-red-500", textColor: "text-red-600" };
        }


        // --- ‚òÖ‚òÖ‚òÖ UPDATED: Modal Functions (Handles Audio) ‚òÖ‚òÖ‚òÖ ---
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('is-open');
                void modal.offsetWidth;
                modal.classList.add('opacity-100', 'pointer-events-auto');
                modal.querySelector('.modal-content').classList.add('scale-100');
                modal.querySelector('.modal-content').classList.remove('scale-95');

                // If opening Meditation modal, initialize and potentially start audio
                if (modalId === 'meditationModal') {
                    resetMeditationTimer(); // Reset timer UI
                    initializeAudio(); // Prepare audio synth
                    // Optionally auto-play sound, or wait for user click
                     // toggleAudioPlay(); // Uncomment to auto-play
                    btnAudioTogglePlay.disabled = false; // Enable audio play button
                }
            }
        }
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal && modal.classList.contains('is-open')) { // Check if it's actually open
                modal.classList.add('is-closing');
                modal.classList.remove('opacity-100', 'pointer-events-auto');
                modal.querySelector('.modal-content').classList.remove('scale-100');
                modal.querySelector('.modal-content').classList.add('scale-95');

                 // If closing Meditation modal, stop timer and audio
                if (modalId === 'meditationModal') {
                    stopMeditationTimer();
                    stopAudio(); // Stop audio playback
                    btnAudioTogglePlay.disabled = true; // Disable button when modal closed
                }

                setTimeout(() => {
                    modal.classList.remove('is-open', 'is-closing');
                }, 200);
            }
        }
         // Close modal if clicking outside the content
        window.addEventListener('click', (event) => {
            if (event.target.classList.contains('modal')) {
                if (medicationModal.classList.contains('is-open')) closeModal('medicationModal');
                if (meditationModal.classList.contains('is-open')) closeModal('meditationModal');
            }
        });

        // --- AI Greeting Logic ---
        function generateGreeting(username) { /* ... (same as before) ... */ }
        function generateGreeting(username) {
            const hour = new Date().getHours();
            let timeOfDayGreeting = "";
            let suggestion = "";

            if (hour < 12) {
                timeOfDayGreeting = "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πâ‡∏≤";
                suggestion = "‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏•‡∏∏‡∏Å‡∏°‡∏≤‡∏Ç‡∏¢‡∏±‡∏ö‡∏ï‡∏±‡∏ß ‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡∏ö‡πâ‡∏≤‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞ üí™";
            } else if (hour < 18) {
                timeOfDayGreeting = "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡∏ö‡πà‡∏≤‡∏¢";
                suggestion = "‡∏û‡∏±‡∏Å‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥ ‡∏¢‡∏∑‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏¢‡∏∑‡∏î‡∏™‡∏≤‡∏¢‡∏™‡∏±‡∏Å‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞ üíß";
            } else {
                timeOfDayGreeting = "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡πÄ‡∏¢‡πá‡∏ô";
                suggestion = "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏≥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏≠‡∏∞‡πÑ‡∏£‡∏°‡∏≤‡∏ö‡πâ‡∏≤‡∏á ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞ üåô";
            }

            // Randomize suggestion slightly (optional)
            const suggestions = [
                 "‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏Ç‡∏¢‡∏±‡∏ö‡∏ï‡∏±‡∏ß ‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡∏ö‡πâ‡∏≤‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞ üí™",
                 "‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏ï‡∏•‡∏≠‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞ üíß",
                 "‡∏´‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡∏™‡∏≤‡∏¢‡∏ï‡∏≤‡∏ö‡πâ‡∏≤‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞ üëÄ",
                 "‡∏ó‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞ üçé",
                 "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏î‡∏µ ‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏´‡∏°‡∏Ñ‡∏∞? üö∂‚Äç‚ôÄÔ∏è"
            ];
             if (hour < 12) {
                 suggestion = suggestions[Math.floor(Math.random() * suggestions.length)];
             } // Keep afternoon/evening suggestions fixed or randomize them too

            return `${timeOfDayGreeting} ‡∏Ñ‡∏∏‡∏ì${username}! ${suggestion}`;
        }


        // --- Fetch Health Data ---
        async function fetchHealthData(lineUserId) { /* ... (same as before) ... */ }
         async function fetchHealthData(lineUserId) {
            // Reset UI
            stepsData.innerText = "Loading...";
            hrData.innerText = "... BPM";
            bmiData.innerText = "...";
            lastSync.innerText = "";
            stepsGoalPercent.innerText = "--%";
            stepsProgressBar.style.width = "0%";
            bmiCategory.innerText = "--";
            bmiCategory.className = "text-gray-500 font-medium text-sm";
            hrStatus.innerHTML = `<div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse"></div><span class="text-gray-500 text-sm font-medium">Loading...</span>`;

            try {
                console.log(`[LIFF] Fetching data for ${lineUserId}`);
                const response = await fetch(`${SERVER_URL}/api/get-dashboard-data?line_user_id=${lineUserId}`, {
                    method: 'GET',
                    headers: {
                        'ngrok-skip-browser-warning': 'true' // Skip ngrok warning page
                    }
                });
                console.log(`[LIFF] Fetch response status: ${response.status}`);

                if (!response.ok) {
                    const errorText = await response.text(); // Get raw text first
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText); // Try parsing as JSON
                    } catch (e) {
                         console.error("[LIFF] Failed to parse error response as JSON:", errorText);
                         errorData = { error: `Server error ${response.status}: ${errorText.substring(0, 100)}` }; // Fallback error
                    }

                    console.error("[LIFF] Fetch error:", errorData);
                    if (response.status === 401 || response.status === 403) {
                        updateConnectButton(false, errorData.error || "Please reconnect Google Fit");
                    } else {
                         updateConnectButton(false, `Server Error ${response.status}`);
                    }
                    // Reset data display on error
                    stepsData.innerText = "-";
                    hrData.innerText = "- BPM";
                    bmiData.innerText = "-";
                    hrStatus.innerHTML = `<div class="w-2 h-2 bg-red-400 rounded-full"></div><span class="text-red-500 text-sm font-medium">Error</span>`;
                    bmiCategory.innerText = "Error";
                    bmiCategory.className = "text-red-500 font-medium text-sm";
                    return; // Stop processing
                }

                const data = await response.json();
                console.log("[LIFF] Data received:", data);

                // Update UI with fetched data
                stepsData.innerText = data.totalSteps !== undefined ? data.totalSteps.toLocaleString() : "-";
                const goalPercent = data.totalSteps !== undefined ? Math.min(Math.round((data.totalSteps / 10000) * 100), 100) : 0;
                stepsGoalPercent.innerText = `${goalPercent}%`;
                stepsProgressBar.style.width = `${goalPercent}%`;

                hrData.innerText = data.avgHeartRate !== undefined ? `${data.avgHeartRate} BPM` : "- BPM";
                const hrStat = getHRStatus(data.avgHeartRate || 0);
                hrStatus.innerHTML = `<div class="w-2 h-2 ${hrStat.color} rounded-full ${data.avgHeartRate > 0 ? 'animate-pulse' : ''}"></div><span class="${hrStat.textColor} text-sm font-medium">${hrStat.text}</span>`;


                bmiData.innerText = data.bmi !== undefined ? data.bmi.toFixed(1) : "-";
                const bmiCat = getBMICategory(data.bmi || 0);
                bmiCategory.innerText = bmiCat.text;
                bmiCategory.className = `${bmiCat.color} font-medium text-sm`;

                lastSync.innerText = `Updated ${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
                updateConnectButton(true); // Mark as connected

            } catch (err) {
                console.error("[LIFF] Fetch Health Data Error (Catch Block):", err);
                stepsData.innerText = "-";
                hrData.innerText = "- BPM";
                bmiData.innerText = "-";
                updateConnectButton(false, `Fetch Error`);
                connectSubtext.innerText = `Error: ${err.message}`;
                connectSubtext.className = "text-xs text-red-500 mt-2 text-center";
                hrStatus.innerHTML = `<div class="w-2 h-2 bg-red-400 rounded-full"></div><span class="text-red-500 text-sm font-medium">Error</span>`;
                bmiCategory.innerText = "Error";
                bmiCategory.className = "text-red-500 font-medium text-sm";
            }
        }


        // --- ‚òÖ‚òÖ‚òÖ NEW: Meditation Timer & Audio Logic ‚òÖ‚òÖ‚òÖ ---

        // Helper function to format time (MM:SS)
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Update Timer UI
        function updateTimerUI() {
            meditationTimeLeft.innerText = formatTime(meditationTimeRemaining);
            const progress = ((meditationTimeTotal - meditationTimeRemaining) / meditationTimeTotal) * 100;
            const circumference = 2 * Math.PI * 88; // radius = 88 from SVG
            meditationProgressCircle.style.strokeDashoffset = circumference * (1 - progress / 100);

            if (meditationTimeRemaining <= 0) {
                meditationStatus.innerText = "Complete!";
            } else {
                meditationStatus.innerText = meditationIsPlaying ? 'Meditating...' : 'Paused';
            }
        }

        // Start the meditation timer
        function startMeditationTimer() {
            if (meditationIsPlaying || meditationTimeRemaining <= 0) return;
            meditationIsPlaying = true;
            meditationStatus.innerText = 'Meditating...';
            // Disable duration buttons while playing
            durationButtons.forEach(btn => btn.disabled = true);
            // Update Play/Pause button UI
            meditationPlayIcon.classList.add('hidden');
            meditationPauseIcon.classList.remove('hidden');
            meditationPlayText.innerText = 'Pause';

            meditationTimerInterval = setInterval(() => {
                meditationTimeRemaining--;
                updateTimerUI();
                if (meditationTimeRemaining <= 0) {
                    stopMeditationTimer(true); // Pass true to indicate completion
                }
            }, 1000);
        }

        // Stop or Pause the meditation timer
        function stopMeditationTimer(isComplete = false) {
            clearInterval(meditationTimerInterval);
            meditationTimerInterval = null;
            meditationIsPlaying = false;
            meditationStatus.innerText = isComplete ? 'Complete!' : 'Paused';
            // Re-enable duration buttons if not complete
            if (!isComplete) {
                durationButtons.forEach(btn => btn.disabled = false);
            }
            // Update Play/Pause button UI
            meditationPlayIcon.classList.remove('hidden');
            meditationPauseIcon.classList.add('hidden');
            meditationPlayText.innerText = 'Start';

            if (isComplete) {
                // Optionally stop audio on completion, or let it continue
                // stopAudio();
                alert('Meditation session complete! Great job! üßò‚Äç‚ôÇÔ∏è');
            }
        }

        // Reset the meditation timer
        function resetMeditationTimer() {
            stopMeditationTimer();
            meditationTimeRemaining = meditationTimeTotal;
            updateTimerUI();
            meditationStatus.innerText = 'Ready';
            durationButtons.forEach(btn => btn.disabled = false); // Ensure buttons are enabled
        }

        // Select a new duration
        function selectMeditationDuration(duration) {
            if (meditationIsPlaying) return; // Cannot change duration while playing
            meditationTimeTotal = duration;
            meditationTimeRemaining = duration;
            updateTimerUI();
            // Update active button style
            durationButtons.forEach(btn => {
                if (parseInt(btn.dataset.duration) === duration) {
                    btn.classList.add('duration-button-active');
                } else {
                    btn.classList.remove('duration-button-active');
                }
            });
        }

         // Initialize Tone.js audio components
        function initializeAudio() {
            if (!audioSynth) {
                console.log("[Audio] Initializing Tone.js Synth...");
                // Create a simple, calming synth sound
                audioSynth = new Tone.MonoSynth({
                    oscillator: { type: "sine" },
                    envelope: { attack: 2, decay: 1, sustain: 0.8, release: 5 },
                    filterEnvelope: { attack: 2, decay: 0.1, sustain: 0.5, release: 5, baseFrequency: 200, octaves: 3 }
                }).toDestination();
                // Set volume (e.g., -12 dB for background music)
                audioSynth.volume.value = -18;
                 console.log("[Audio] Synth created.");

                 // Update mute button based on initial state
                 updateMuteButtonUI();
            }
        }

        // Start audio playback
        function startAudio() {
            if (!audioSynth) initializeAudio(); // Ensure synth exists
            if (!audioIsPlaying) {
                 // IMPORTANT: Start AudioContext on user interaction
                if (!isAudioContextStarted) {
                     Tone.start().then(() => {
                         console.log('[Audio] AudioContext started by user interaction.');
                         isAudioContextStarted = true;
                         // Start playing *after* context is started
                         audioSynth.triggerAttack("C3"); // Play a low C note
                         audioIsPlaying = true;
                         updateAudioPlayButtonUI();
                         console.log("[Audio] Playback started.");
                     }).catch(e => console.error("[Audio] Tone.start error:", e));
                } else {
                     // AudioContext already started, just play
                     audioSynth.triggerAttack("C3");
                     audioIsPlaying = true;
                     updateAudioPlayButtonUI();
                     console.log("[Audio] Playback started.");
                }
            }
        }

        // Stop audio playback
        function stopAudio() {
            if (audioSynth && audioIsPlaying) {
                audioSynth.triggerRelease(); // Fade out the sound
                audioIsPlaying = false;
                updateAudioPlayButtonUI();
                console.log("[Audio] Playback stopped.");
            }
            // Optionally stop the transport if using loops/sequences
            // Tone.Transport.stop();
        }

        // Toggle audio play/pause
        function toggleAudioPlay() {
             // Ensure AudioContext starts on the first play attempt
            if (!isAudioContextStarted) {
                startAudio(); // startAudio handles Tone.start()
            } else if (audioIsPlaying) {
                stopAudio();
            } else {
                startAudio();
            }
        }


        // Toggle audio mute/unmute
        function toggleAudioMute() {
            if (!audioSynth) return; // No audio to mute
            audioIsMuted = !audioIsMuted;
            Tone.Destination.mute = audioIsMuted;
            updateMuteButtonUI();
             console.log(`[Audio] Mute toggled: ${audioIsMuted}`);
        }

        // Update UI for Audio Play/Pause button
        function updateAudioPlayButtonUI() {
            if (audioIsPlaying) {
                audioPlayIcon.classList.add('hidden');
                audioPauseIcon.classList.remove('hidden');
                 // Replace placeholder icons if you have actual SVGs
                // Use SVG content directly if needed
                audioPlayIcon.innerHTML = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>`; // Play Icon
                audioPauseIcon.innerHTML = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h1a1 1 0 100-2H8V8a1 1 0 000-1zM11 8a1 1 0 100-2h1a1 1 0 100 2h-1z" clip-rule="evenodd" /></svg>`; // Pause Icon
            } else {
                audioPlayIcon.classList.remove('hidden');
                audioPauseIcon.classList.add('hidden');
                 // Replace placeholder icons
                audioPlayIcon.innerHTML = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>`; // Play Icon
                audioPauseIcon.innerHTML = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h1a1 1 0 100-2H8V8a1 1 0 000-1zM11 8a1 1 0 100-2h1a1 1 0 100 2h-1z" clip-rule="evenodd" /></svg>`; // Pause Icon
            }
        }
         // Update UI for Audio Mute/Unmute button
        function updateMuteButtonUI() {
             if (audioIsMuted) {
                audioMuteIcon.classList.remove('hidden');
                audioUnmuteIcon.classList.add('hidden');
                 // Replace icons
                 audioMuteIcon.innerHTML = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-1.707-8.707a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.293 9.293z" clip-rule="evenodd" /></svg>`; // Mute icon
                 audioUnmuteIcon.innerHTML = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M7 9a3 3 0 013-3h1a3 3 0 110 6H8a1 1 0 00-1 1v1a1 1 0 102 0v-1h2a5 5 0 000-10H8a3 3 0 00-3 3v2a1 1 0 102 0V9zm11.5-4.5a.5.5 0 01.5.5v10a.5.5 0 01-1 0V5a.5.5 0 01.5-.5zm-3 0a.5.5 0 01.5.5v10a.5.5 0 01-1 0V5a.5.5 0 01.5-.5z"/></svg>`; // Unmute icon
            } else {
                audioMuteIcon.classList.add('hidden');
                audioUnmuteIcon.classList.remove('hidden');
                 // Replace icons
                 audioMuteIcon.innerHTML = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-1.707-8.707a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.293 9.293z" clip-rule="evenodd" /></svg>`; // Mute icon
                 audioUnmuteIcon.innerHTML = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M7 9a3 3 0 013-3h1a3 3 0 110 6H8a1 1 0 00-1 1v1a1 1 0 102 0v-1h2a5 5 0 000-10H8a3 3 0 00-3 3v2a1 1 0 102 0V9zm11.5-4.5a.5.5 0 01.5.5v10a.5.5 0 01-1 0V5a.5.5 0 01.5-.5zm-3 0a.5.5 0 01.5.5v10a.5.5 0 01-1 0V5a.5.5 0 01.5-.5z"/></svg>`; // Unmute icon
            }
        }


        // --- LIFF Initialization ---
        async function initializeLiff() { /* ... (same as before) ... */ }
         async function initializeLiff() {
            showLoading();
            console.log("[LIFF] Initializing...");
            try {
                await liff.init({ liffId: LIFF_ID });
                console.log("[LIFF] Init success!");

                if (!liff.isLoggedIn()) {
                    console.log("[LIFF] Not logged in, showing login button.");
                    showLogin();
                } else {
                    console.log("[LIFF] Logged in, showing app.");
                    showApp();
                    const profile = await liff.getProfile();
                    console.log("[LIFF] Profile fetched:", profile);
                    userPicture.src = profile.pictureUrl;
                    userPicture.onerror = () => {
                         userPicture.src='https://placehold.co/80x80/E5E7EB/A1A1AA?text=Err';
                         console.warn("[LIFF] Failed to load profile picture.");
                    };
                    displayName.innerText = profile.displayName;
                    userId.innerText = profile.userId;

                    // Set Greeting Message
                    greetingMessage.innerText = generateGreeting(profile.displayName);

                    console.log("[LIFF] Checking URL params...");
                    const processedRedirect = checkUrlParams(); // Check if just returned from OAuth
                    if (!processedRedirect) {
                        console.log("[LIFF] Not a redirect, fetching health data...");
                        await fetchHealthData(profile.userId); // Fetch data if logged in and not redirecting
                    } else {
                        console.log("[LIFF] Processed redirect, data fetch triggered by checkUrlParams.");
                    }
                }
            } catch (e) {
                console.error("[LIFF] Init Error:", e);
                 // Display error to user if init fails
                loadingState.innerHTML = `<p class="text-lg text-red-500">LIFF Initialization Failed: ${e.message}</p>`;
                showLoading(); // Keep showing loading state but with error
            }
        }


        // --- Check URL Params ---
        function checkUrlParams() { /* ... (same as before) ... */ }
         function checkUrlParams() {
            const params = new URLSearchParams(window.location.search);
            let processedParams = false;
            if (params.has('connect') && params.get('connect') === 'success') {
                console.log("[LIFF] Connect success param found.");
                updateConnectButton(true, "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");
                processedParams = true;
                // Fetch data immediately after successful connection
                liff.getProfile().then(profile => {
                    console.log("[LIFF] Fetching data after successful connect...");
                    fetchHealthData(profile.userId);
                });
            } else if (params.has('error')) {
                const errorMsg = params.get('error');
                console.log(`[LIFF] Connect error param found: ${errorMsg}`);
                updateConnectButton(false, `Connection failed: ${errorMsg}`);
                processedParams = true;
            }

            // Clear URL params if they were processed
            if (processedParams) {
                 console.log("[LIFF] Clearing URL params.");
                 window.history.replaceState({}, document.title, window.location.pathname);
            }
            return processedParams;
        }


        // --- Event Listeners ---
        btnLogin.addEventListener("click", () => { /* ... (same as before) ... */ });
        btnLogout.addEventListener("click", () => { /* ... (same as before) ... */ });
        btnConnectHealth.addEventListener("click", async () => { /* ... (same as before) ... */ });
        // Modal triggers
        btnMedication.addEventListener("click", () => { /* ... (same as before) ... */ });
         btnLogin.addEventListener("click", () => {
             console.log("[LIFF] Login button clicked.");
            liff.login({ redirectUri: window.location.href });
        });

        btnLogout.addEventListener("click", () => {
            if (liff.isLoggedIn()) {
                console.log("[LIFF] Logout button clicked.");
                // Using simple confirm
                if (confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
                     console.log("[LIFF] Logging out...");
                    liff.logout();
                    window.location.reload();
                } else {
                     console.log("[LIFF] Logout cancelled.");
                }
            }
        });

        btnConnectHealth.addEventListener("click", async () => {
            if (btnConnectHealth.disabled) return;
            console.log("[LIFF] Connect Health button clicked.");
            btnConnectHealth.disabled = true; // Disable immediately
            connectText.innerText = "Connecting...";
            connectPulse.classList.add('hidden'); // Hide pulse during connection attempt


            try {
                const profile = await liff.getProfile();
                const lineUserId = profile.userId;
                const authUrl = `${SERVER_URL}/auth/google/start?line_user_id=${lineUserId}`;
                 console.log(`[LIFF] Starting auth flow for ${lineUserId} at ${authUrl}`);
                if (liff.isInClient()) {
                    console.log("[LIFF] Opening external window for auth.");
                     // Using simple alert
                    alert("‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô Google...");
                    liff.openWindow({ url: authUrl, external: true });
                     // Don't re-enable immediately, rely on checkUrlParams or fetchHealthData failure
                } else {
                    console.log("[LIFF] Redirecting in current window for auth.");
                    window.location.href = authUrl; // Open in same window if outside LINE
                }
            } catch (err) {
                console.error("[LIFF] Error starting auth flow:", err);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: " + err.message);
                updateConnectButton(false, "Connection Error"); // Update button state on error
            }
        });

        // Modal triggers
        btnMedication.addEventListener("click", () => {
             console.log("[LIFF] Medication button clicked.");
            openModal('medicationModal');
        });

        // ‚òÖ‚òÖ‚òÖ UPDATED: btnMeditation Listener (Starts AudioContext) ‚òÖ‚òÖ‚òÖ
        btnMeditation.addEventListener("click", async () => {
            console.log("[LIFF] Meditation button clicked.");
            // IMPORTANT: Start AudioContext on user interaction BEFORE opening modal
            if (!isAudioContextStarted && Tone.context.state !== 'running') {
                try {
                    await Tone.start();
                    console.log('[Audio] AudioContext started by button click.');
                    isAudioContextStarted = true;
                } catch (e) {
                    console.error("[Audio] Failed to start AudioContext:", e);
                    alert("Could not start audio. Please interact with the page first.");
                    return; // Don't open modal if audio fails to start
                }
            }
            openModal('meditationModal'); // Now open the modal
        });

        // Meditation Timer Listeners
        btnMeditationTogglePlay.addEventListener('click', () => {
            if (meditationIsPlaying) {
                stopMeditationTimer();
            } else {
                startMeditationTimer();
            }
        });
        btnMeditationReset.addEventListener('click', resetMeditationTimer);
        durationButtons.forEach(button => {
            button.addEventListener('click', () => {
                const duration = parseInt(button.dataset.duration);
                selectMeditationDuration(duration);
            });
        });

        // ‚òÖ‚òÖ‚òÖ NEW: Audio Control Listeners ‚òÖ‚òÖ‚òÖ
        btnAudioTogglePlay.addEventListener('click', toggleAudioPlay);
        btnAudioToggleMute.addEventListener('click', toggleAudioMute);


        // --- Run ---
        document.addEventListener("DOMContentLoaded", initializeLiff);

    </script>
</body>
</html>

