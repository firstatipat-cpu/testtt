<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CareBuddy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+Thai:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans Thai', 'Inter', sans-serif; }
        .modal { display: none; }
        .modal.is-open { display: flex; opacity: 1; pointer-events: auto; }
        .modal.is-closing { opacity: 0; pointer-events: none; }
        .modal .modal-content { transform: scale(0.95); transition: transform 0.2s ease-out, opacity 0.2s ease-out; }
        .modal.is-open .modal-content { transform: scale(1); }
        .bg-gradient-pink-rose { background-image: linear-gradient(to bottom right, #EC4899, #F43F5E); }
        .hover\:bg-gradient-pink-rose-dark:hover { background-image: linear-gradient(to bottom right, #DB2777, #E11D48); }
        .bg-gradient-indigo-purple { background-image: linear-gradient(to bottom right, #6366F1, #A855F7); }
        .hover\:bg-gradient-indigo-purple-dark:hover { background-image: linear-gradient(to bottom right, #4F46E5, #9333EA); }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #059669; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Active/Inactive button styles (Matches Figma) */
        .control-button-active { background-color: #8B5CF6 !important; /* purple-500 */ color: white !important; border-color: transparent !important; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);}
        .control-button-inactive { background-color: #F3F4F6; /* gray-100 */ color: #4B5563; /* gray-600 */ border-color: transparent; }
        .control-button-inactive:hover:not(:disabled) { background-color: #E5E7EB; /* gray-200 */ }
        /* Progress Circle Transition */
        #meditationProgressCircle { transition: stroke-dashoffset 1s linear; }
        /* Gradient for progress circle */
        #meditationGradient stop[offset="0%"] { stop-color: #8B5CF6; } /* purple-500 */
        #meditationGradient stop[offset="100%"] { stop-color: #6366F1; } /* indigo-500 */
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen">

    <div class="container mx-auto px-4 py-6 max-w-md">

        <div id="loadingState" class="flex flex-col items-center justify-center min-h-[70vh] text-center p-10">
            <div class="spinner mb-4"></div>
            <p class="text-lg text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
        </div>

        <div id="loginState" class="hidden text-center p-10 bg-white rounded-xl shadow-lg mt-10">
            <h1 class="text-2xl font-semibold text-green-600 mb-2">LINE Health App</h1>
            <p class="text-gray-600 mb-6">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏ö‡∏±‡∏ç‡∏ä‡∏µ LINE ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
            <button id="btnLogin" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition duration-200">
                ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ LINE
            </button>
        </div>

        <div id="appState" class="hidden space-y-6">

            <div class="mb-4">
                <h1 class="text-2xl font-semibold text-green-600 mb-1">LINE Health App</h1>
                <p class="text-gray-600">Track your health with Google Fit</p>
            </div>

            <div id="greetingSection" class="bg-white rounded-xl p-4 shadow text-center mb-6">
                <p id="greetingMessage" class="text-gray-700">...</p>
            </div>

            <div id="profileSection" class="bg-white rounded-2xl p-6 shadow-lg">
                 <div class="flex items-center gap-4">
                     <img id="userPicture" class="w-20 h-20 rounded-full border-4 border-green-100 object-cover bg-gray-100 flex-shrink-0" src="https://placehold.co/80x80/E5E7EB/A1A1AA?text=?" alt="User Picture" onerror="this.onerror=null; this.src='https://placehold.co/80x80/E5E7EB/A1A1AA?text=Err';">
                     <div class="flex-1 min-w-0">
                         <h2 id="displayName" class="text-xl font-semibold text-gray-900 mb-1 truncate">...</h2>
                         <p class="text-xs text-gray-500 break-all">
                             ID: <span id="userId">...</span>
                         </p>
                     </div>
                     <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center flex-shrink-0">
                         <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                             <path d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63h2.386c.346 0 .627.285.627.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.105.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345 0 .63.285.63.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63.346 0 .628.285.628.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.63 0 .344-.282.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314"/>
                         </svg>
                     </div>
                 </div>
            </div>

            <div id="connectSection" class="mb-6">
                <button id="btnConnectHealth" class="w-full bg-white rounded-xl p-4 shadow-md hover:shadow-lg transition-shadow flex items-center justify-center gap-3 text-gray-700 font-medium disabled:opacity-70 disabled:cursor-not-allowed">
                    <svg class="w-6 h-6" fill="#428df5" viewBox="0 0 24 24" role="img" xmlns="http://www.w3.org/2000/svg">
                            <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                            <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                            <g id="SVGRepo_iconCarrier">
                                <path d="M23.218 4.868c-1.235-2.194-3.927-3.356-6.378-2.843-1.11.243-2.173.774-2.979 1.583-.622.613-1.242 1.229-1.864 1.841-.915-.91-1.788-1.937-2.882-2.648a5.98 5.98 0 0 0-3.904-.845c-4.757.578-6.936 6.346-3.615 9.85 3.481 3.418 6.937 6.863 10.413 10.288 3.291-3.251 6.573-6.51 9.871-9.752 2.132-1.831 2.8-5.026 1.338-7.474zM6.162 11.223c-.692-.755-1.511-1.404-2.141-2.208-.821-1.218-.158-3.012 1.26-3.397.781-.256 1.683-.031 2.279.527.627.609 1.236 1.237 1.866 1.843l.005.006a414.706 414.706 0 0 0-3.269 3.229zm5.846 5.758a3300.079 3300.079 0 0 1-3.255-3.22c2.555-2.516 5.103-5.042 7.65-7.566.393-.394.93-.646 1.487-.673 2.086-.154 3.285 2.372 1.801 3.866-2.549 2.542-5.121 5.062-7.683 7.593z"></path>
                            </g>
                        </svg>
                    <span id="connectText">Connect to Google Fit</span>
                    <div id="connectPulse" class="w-3 h-3 bg-green-500 rounded-full animate-pulse hidden ml-2 flex-shrink-0"></div>
                </button>
                <p id="connectSubtext" class="text-xs text-gray-500 mt-2 text-center"></p>
            </div>

            <div id="dashboardSection" class="space-y-4">
                 <div class="flex items-center justify-between mb-2">
                     <h3 class="text-lg font-semibold text-gray-900">Your Health Metrics</h3>
                     <span id="lastSync" class="text-gray-400 text-xs"></span>
                 </div>
                 <div class="bg-white rounded-xl p-6 shadow-md border-0 hover:shadow-lg transition-shadow">
                     <div class="flex items-center justify-between mb-4">
                         <div class="flex items-center gap-4 min-w-0">
                             <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center flex-shrink-0">
                                 <svg viewBox="-97 0 512 512" version="1.1" xmlns="http://www.w3.org/2000/svg" fill="#0084ff" stroke="#0084ff"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"><path fill="" d="M68.822,394.263l21.259,-49.604l51.65,51.65l-16.93,34.695c-1.613,3.306 -3.784,6.309 -6.418,8.877l-63.912,62.324c-12.504,12.193 -32.56,12.023 -44.961,-0.275c-12.627,-12.523 -12.708,-33.027 -0.073,-45.543l52.492,-51.994c2.929,-2.901 5.269,-6.341 6.893,-10.13Zm25.076,-180.83l26.489,-10.52l-18.105,82.627c-1.075,4.907 0.217,10.035 3.489,13.846l0.28,0.326l53.312,60.288l-0.167,0.517l0.224,-0.46l32.816,44.244c2.456,3.31 4.249,7.065 5.28,11.056l18.488,71.534c4.45,17.218 22.205,27.473 39.384,22.87c16.869,-4.52 27.116,-21.762 22.878,-38.705l-21.323,-85.252c-1.111,-4.444 -3.163,-8.597 -6.018,-12.179l-54.38,-68.24l16.859,-65.748l9.711,25.748c2.123,5.629 5.789,10.546 10.579,14.186l33.912,25.773c14.026,10.66 34.04,7.965 44.762,-6.013c10.783,-14.057 8.104,-34.213 -5.99,-44.947l-25.107,-19.123c-4.523,-3.445 -8.047,-8.033 -10.208,-13.292l-21.681,-52.748c-2.806,-6.826 -7.906,-12.036 -14.053,-15.086l0.034,-0.135c0,0 -25.696,-17.436 -44.5,-22.5c-19.553,-5.265 -50.639,-1.941 -54.17,-1.538c-3.94,-0.014 -7.947,0.704 -11.834,2.238l-72.866,28.762c-1.72,0.679 -3.217,1.821 -4.327,3.299l-33.134,44.146c-10.593,14.114 -7.735,34.159 6.357,44.782c14.112,10.639 34.204,7.844 44.842,-6.268l21.296,-28.249c1.767,-2.343 4.144,-4.155 6.871,-5.239Zm105.465,-101.433c30.928,0 56,-25.072 56,-56c0,-30.928 -25.072,-56 -56,-56c-30.928,0 -56,25.072 -56,56c0,30.928 25.072,56 56,56Z"></path></g></svg>
                             </div>
                             <div class="min-w-0">
                                 <p class="text-sm text-gray-500 truncate">Steps Today</p>
                                 <p id="stepsData" class="text-xl font-semibold text-gray-900 truncate">...</p>
                             </div>
                         </div>
                         <div class="text-right flex-shrink-0 ml-2">
                             <div id="stepsGoalPercent" class="text-blue-600 text-sm font-medium">--%</div>
                             <div class="text-gray-400 text-xs">of 10K goal</div>
                         </div>
                     </div>
                     <div class="bg-gray-100 rounded-full h-2 overflow-hidden">
                         <div id="stepsProgressBar" class="bg-blue-500 h-full transition-all duration-500" style="width: 0%"></div>
                     </div>
                 </div>
                 <div class="bg-white rounded-xl p-6 shadow-md border-0 hover:shadow-lg transition-shadow">
                       <div class="flex items-center justify-between">
                           <div class="flex items-center gap-4 min-w-0">
                               <div class="w-12 h-12 bg-red-100 rounded-xl flex items-center justify-center flex-shrink-0">
                                   <svg viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg" fill="#ff0000" stroke="#ff0000"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"><path d="m0 6.5h2l2.5-6 2 12 3-9 2.095 6 1.405-3h2" fill="none" stroke="" stroke-linecap="round" stroke-linejoin="round" transform="translate(3 4)"></path></g></svg>
                               </div>
                               <div class="min-w-0">
                                   <p class="text-sm text-gray-500 truncate">Heart Rate (Avg)</p>
                                   <p id="hrData" class="text-xl font-semibold text-gray-900 truncate">... <span class="text-xs font-normal">BPM</span></p>
                               </div>
                           </div>
                           <div id="hrStatus" class="flex items-center gap-2 flex-shrink-0 ml-2">
                                <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
                               <span class="text-gray-500 text-sm font-medium">--</span>
                           </div>
                       </div>
                  </div>
                 <div class="bg-white rounded-xl p-6 shadow-md border-0 hover:shadow-lg transition-shadow">
                       <div class="flex items-center justify-between">
                           <div class="flex items-center gap-4 min-w-0">
                               <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center flex-shrink-0">
                                   <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                               </div>
                               <div class="min-w-0">
                                   <p class="text-sm text-gray-500 truncate">Body Mass Index</p>
                                   <p id="bmiData" class="text-xl font-semibold text-gray-900 truncate">...</p>
                               </div>
                           </div>
                           <div class="text-right flex-shrink-0 ml-2">
                                <span id="bmiCategory" class="text-gray-500 font-medium text-sm">--</span>
                           </div>
                       </div>
                  </div>
            </div>

            <div id="actionButtons" class="grid grid-cols-2 gap-4 pt-4">
                <button id="btnMedication" class="h-auto py-6 flex flex-col items-center justify-center gap-2 bg-gradient-pink-rose hover:bg-gradient-pink-rose-dark shadow-lg text-white rounded-xl transition duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-500">
                     <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.368-.825a2 2 0 01-1.022-.547L12.572 11h-1.144l-2.443 2.509a2 2 0 01-1.022.547l-2.368.825a2 2 0 00-1.022.547L3 17.25a2 2 0 002 2h14a2 2 0 002-2l-1.572-1.822zM12 2a4 4 0 014 4h-8a4 4 0 014-4z"></path></svg>
                     <span class="text-sm font-medium">Medication</span>
                 </button>
                 <button id="btnMeditation" class="h-auto py-6 flex flex-col items-center justify-center gap-2 bg-gradient-indigo-purple hover:bg-gradient-indigo-purple-dark shadow-lg text-white rounded-xl transition duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                      <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg>
                     <span class="text-sm font-medium">Meditation</span>
                 </button>
            </div>

            <button id="btnLogout" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 rounded-lg mt-4 transition duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
            </button>
        </div>
    </div>

    <div id="medicationModal" class="modal fixed inset-0 z-50 items-center justify-center bg-black/60 p-4 backdrop-blur-sm transition-opacity duration-200 opacity-0 pointer-events-none">
        <div class="modal-content bg-white rounded-lg p-6 max-w-sm w-full shadow-xl transition-transform duration-200">
            <div class="flex items-center gap-2 mb-4">
                 <svg class="w-5 h-5 text-pink-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.368-.825a2 2 0 01-1.022-.547L12.572 11h-1.144l-2.443 2.509a2 2 0 01-1.022.547l-2.368.825a2 2 0 00-1.022.547L3 17.25a2 2 0 002 2h14a2 2 0 002-2l-1.572-1.822zM12 2a4 4 0 014 4h-8a4 4 0 014-4z"></path></svg>
                <h2 class="text-lg font-semibold text-gray-900">Medication Reminder</h2>
            </div>
            <p class="text-gray-600 mb-6 text-sm">‡∏ï‡∏±‡πâ‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</p>
            <button onclick="closeModal('medicationModal')" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 rounded-lg text-sm font-medium transition duration-200">Close</button>
        </div>
    </div>
    <div id="meditationModal" class="modal fixed inset-0 z-50 items-center justify-center bg-black/60 p-4 backdrop-blur-sm transition-opacity duration-200 opacity-0 pointer-events-none">
         <div class="modal-content bg-white rounded-lg p-6 max-w-sm w-full shadow-xl transition-transform duration-200 relative">
             <button onclick="closeModal('meditationModal')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors z-10">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <div class="flex items-center gap-2 mb-2">
                 <svg class="w-6 h-6 text-indigo-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg>
                <h2 class="text-lg font-semibold text-gray-900">Meditation Session</h2>
            </div>
            <p class="text-gray-500 mb-6 text-sm">Take a moment to relax and focus on your breathing</p>
            <div class="relative mb-6">
                <div class="w-48 h-48 mx-auto relative">
                    <svg class="w-full h-full transform -rotate-90">
                        <circle cx="96" cy="96" r="88" stroke="#E5E7EB" stroke-width="8" fill="none" />
                        <circle id="meditationProgressCircle" cx="96" cy="96" r="88" stroke="url(#meditationGradient)" stroke-width="8" fill="none" stroke-dasharray="553" stroke-dashoffset="553" stroke-linecap="round" />
                        <defs> <linearGradient id="meditationGradient" x1="0%" y1="0%" x2="0%" y2="100%"> <stop offset="0%" stop-color="#8B5CF6" /> <stop offset="100%" stop-color="#6366F1" /> </linearGradient> </defs>
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center flex-col">
                        <span id="meditationTimeLeft" class="text-3xl font-semibold text-gray-800">3:00</span>
                        <span id="meditationStatus" class="text-gray-500 text-sm mt-1">Ready</span>
                    </div>
                </div>
            </div>
            <div class="space-y-2 mb-6">
                 <label class="text-sm font-medium text-gray-700">Select Sound</label>
                 
                 <div class="grid grid-cols-2 gap-2">
                      <button data-sound="song1" class="sound-select-btn control-button-active py-2 rounded-lg text-sm font-medium transition duration-200 disabled:opacity-50"> ‡πÄ‡∏û‡∏•‡∏á‡∏ó‡∏µ‡πà 1 </button>
                      <button data-sound="song2" class="sound-select-btn control-button-inactive py-2 rounded-lg text-sm font-medium transition duration-200 disabled:opacity-50"> ‡πÄ‡∏û‡∏•‡∏á‡∏ó‡∏µ‡πà 2 </button>
                 </div>
                 </div>
            <div class="space-y-2 mb-6">
                <label class="text-sm font-medium text-gray-700">Duration</label>
                <div class="grid grid-cols-4 gap-2">
                    <button data-duration="180" class="meditation-duration-btn control-button-active py-2 rounded-lg text-sm font-medium transition duration-200 disabled:opacity-50">3m</button>
                    <button data-duration="300" class="meditation-duration-btn control-button-inactive py-2 rounded-lg text-sm font-medium transition duration-200 disabled:opacity-50">5m</button>
                    <button data-duration="600" class="meditation-duration-btn control-button-inactive py-2 rounded-lg text-sm font-medium transition duration-200 disabled:opacity-50">10m</button>
                    <button data-duration="900" class="meditation-duration-btn control-button-inactive py-2 rounded-lg text-sm font-medium transition duration-200 disabled:opacity-50">15m</button>
                </div>
            </div>
            <div class="flex gap-3 mb-6">
                <button id="btnMeditationTogglePlay" class="flex-1 bg-gradient-indigo-purple hover:bg-gradient-indigo-purple-dark text-white font-medium py-3 px-4 rounded-lg flex items-center justify-center gap-2 transition duration-200 shadow-md">
                    <svg id="meditationPlayIcon" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>
                    <svg id="meditationPauseIcon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 011-1h1a1 1 0 110 2H8a1 1 0 01-1-1zm5 0a1 1 0 011-1h1a1 1 0 110 2h-1a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                    <span id="meditationPlayText" class="text-base">Start</span>
                </button>
                <button id="btnMeditationReset" class="p-3 border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-100 transition duration-200 shadow-sm">
                     <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9M3.22 13.582A8.001 8.001 0 0019.418 15M20 20v-5h-.581"></path></svg>
                </button>
                <button id="btnAudioToggleMute" class="p-3 border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-100 transition duration-200 shadow-sm" title="Mute/Unmute Sound">
                     <svg id="audioUnmuteIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>
                     <svg id="audioMuteIcon" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" clip-rule="evenodd"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l4-4m0 4l-4-4"></path></svg>
                </button>
            </div>
            <div id="breathingGuide" class="text-center p-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg hidden">
                <p class="text-gray-700 mb-1 font-medium">Breathing Guide</p>
                <p class="text-gray-600 text-sm">‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡πÄ‡∏Ç‡πâ‡∏≤ 4 ‡∏ß‡∏¥, ‡∏Å‡∏•‡∏±‡πâ‡∏ô‡∏´‡∏≤‡∏¢‡πÉ‡∏à 4 ‡∏ß‡∏¥, ‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏≠‡∏≠‡∏Å 4 ‡∏ß‡∏¥</p>
            </div>
         </div>
    </div>
    <script>
        // --- DOM Elements ---
        // (Copied - No changes needed)
        const loadingState = document.getElementById("loadingState"); const loginState = document.getElementById("loginState"); const appState = document.getElementById("appState"); const btnLogin = document.getElementById("btnLogin"); const btnLogout = document.getElementById("btnLogout"); const btnConnectHealth = document.getElementById("btnConnectHealth"); const userPicture = document.getElementById("userPicture"); const displayName = document.getElementById("displayName"); const userId = document.getElementById("userId"); const greetingMessage = document.getElementById("greetingMessage"); const connectText = document.getElementById("connectText"); const connectSubtext = document.getElementById("connectSubtext"); const connectPulse = document.getElementById("connectPulse"); const lastSync = document.getElementById("lastSync"); const stepsData = document.getElementById("stepsData"); const stepsGoalPercent = document.getElementById("stepsGoalPercent"); const stepsProgressBar = document.getElementById("stepsProgressBar"); const hrData = document.getElementById("hrData"); const hrStatus = document.getElementById("hrStatus"); const bmiData = document.getElementById("bmiData"); const bmiCategory = document.getElementById("bmiCategory"); const btnMedication = document.getElementById("btnMedication"); const btnMeditation = document.getElementById("btnMeditation"); const medicationModal = document.getElementById("medicationModal"); const meditationModal = document.getElementById("meditationModal"); const meditationTimeLeft = document.getElementById("meditationTimeLeft"); const meditationStatus = document.getElementById("meditationStatus"); const meditationProgressCircle = document.getElementById("meditationProgressCircle"); const durationButtons = document.querySelectorAll(".meditation-duration-btn"); const btnMeditationTogglePlay = document.getElementById("btnMeditationTogglePlay"); const meditationPlayIcon = document.getElementById("meditationPlayIcon"); const meditationPauseIcon = document.getElementById("meditationPauseIcon"); const meditationPlayText = document.getElementById("meditationPlayText"); const btnMeditationReset = document.getElementById("btnMeditationReset"); const breathingGuide = document.getElementById("breathingGuide"); const btnAudioToggleMute = document.getElementById("btnAudioToggleMute"); const audioMuteIcon = document.getElementById("audioMuteIcon"); const audioUnmuteIcon = document.getElementById("audioUnmuteIcon"); const soundSelectButtons = document.querySelectorAll(".sound-select-btn");

        // --- Configuration ---
        // (Copied - No changes needed)
        const LIFF_ID = "2008337931-z1xeJb7D"; // üî∏ MUST BE YOUR LIFF ID
        const SERVER_URL = "https://sequential-seborrheal-clelia.ngrok-free.dev"; // üîó MUST BE YOUR NGROK URL

        // --- State Variables ---
        // (Copied - No changes needed)
        let meditationTimerInterval = null; let meditationIsPlaying = false; let meditationTimeTotal = 180; let meditationTimeRemaining = 180; let audioPlayers = {}; let currentAudioPlayer = null; 
        
        // üëá ‚òÖ‚òÖ‚òÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] 1. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô 'song1' ‚òÖ‚òÖ‚òÖ
        let selectedSoundType = 'song1'; 
        
        let audioIsPlaying = false; let audioIsMuted = false; let isAudioContextStarted = false;

        // --- UI Functions ---
        // (Copied - No changes needed)
        function showLoading() { loadingState.style.display = "flex"; loginState.style.display = "none"; appState.style.display = "none"; } function showLogin() { loadingState.style.display = "none"; loginState.style.display = "block"; appState.style.display = "none"; } function showApp() { loadingState.style.display = "none"; loginState.style.display = "none"; appState.style.display = "block"; } function updateConnectButton(connected, message = null) { if (connected) { connectText.innerText = "Connected"; btnConnectHealth.classList.add("bg-green-100", "text-green-700", "cursor-not-allowed"); btnConnectHealth.classList.remove("bg-white", "hover:shadow-lg"); btnConnectHealth.disabled = true; connectPulse.classList.remove("hidden"); connectSubtext.innerText = message || `Last sync: ${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`; connectSubtext.className = "text-xs text-green-600 mt-2 text-center"; } else { connectText.innerText = "Connect to Google Fit"; btnConnectHealth.classList.remove("bg-green-100", "text-green-700", "cursor-not-allowed"); btnConnectHealth.classList.add("bg-white", "hover:shadow-lg"); btnConnectHealth.disabled = false; connectPulse.classList.add("hidden"); connectSubtext.innerText = message || "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"; connectSubtext.className = `text-xs mt-2 text-center ${message ? 'text-red-500' : 'text-gray-500'}`; } } function getBMICategory(bmi) { if (bmi <= 0) return { text: "--", color: "text-gray-500" }; if (bmi < 18.5) return { text: "Underweight", color: "text-blue-600" }; if (bmi < 25) return { text: "Normal", color: "text-green-600" }; if (bmi < 30) return { text: "Overweight", color: "text-orange-600" }; return { text: "Obese", color: "text-red-600" }; } function getHRStatus(hr) { if (hr <= 0) return { text: "--", color: "bg-gray-400", textColor: "text-gray-500" }; if (hr < 60) return { text: "Resting", color: "bg-blue-500", textColor: "text-blue-600" }; if (hr <= 100) return { text: "Normal", color: "bg-green-500", textColor: "text-green-600" }; return { text: "Elevated", color: "bg-red-500", textColor: "text-red-600" }; }

        // --- Modal Functions ---
        // (Copied - No changes needed)
        function openModal(modalId) { const modal = document.getElementById(modalId); if (modal) { modal.classList.add('is-open'); void modal.offsetWidth; modal.classList.add('opacity-100', 'pointer-events-auto'); modal.querySelector('.modal-content').classList.add('scale-100'); modal.querySelector('.modal-content').classList.remove('scale-95'); if (modalId === 'meditationModal') { resetMeditationTimer(); selectSound(selectedSoundType); selectMeditationDuration(meditationTimeTotal); initializeAudio(); updateMuteButtonUI(); } } } function closeModal(modalId) { const modal = document.getElementById(modalId); if (modal && modal.classList.contains('is-open')) { modal.classList.add('is-closing'); modal.classList.remove('opacity-100', 'pointer-events-auto'); modal.querySelector('.modal-content').classList.remove('scale-100'); modal.querySelector('.modal-content').classList.add('scale-95'); if (modalId === 'meditationModal') { stopMeditationTimer(); stopAudio(); } setTimeout(() => { modal.classList.remove('is-open', 'is-closing'); }, 200); } } window.addEventListener('click', (event) => { if (event.target.classList.contains('modal')) { if (medicationModal.classList.contains('is-open')) closeModal('medicationModal'); if (meditationModal.classList.contains('is-open')) closeModal('meditationModal'); } });

        // --- AI Greeting Logic ---
        // (Copied - No changes needed)
        function generateGreeting(username) { const hour = new Date().getHours(); let timeOfDayGreeting = ""; let suggestion = ""; if (hour < 12) { timeOfDayGreeting = "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πâ‡∏≤"; suggestion = "‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏•‡∏∏‡∏Å‡∏°‡∏≤‡∏Ç‡∏¢‡∏±‡∏ö‡∏ï‡∏±‡∏ß ‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡∏ö‡πâ‡∏≤‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞ üí™"; } else if (hour < 18) { timeOfDayGreeting = "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡∏ö‡πà‡∏≤‡∏¢"; suggestion = "‡∏û‡∏±‡∏Å‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥ ‡∏¢‡∏∑‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏¢‡∏∑‡∏î‡∏™‡∏≤‡∏¢‡∏™‡∏±‡∏Å‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞ üíß"; } else { timeOfDayGreeting = "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡πÄ‡∏¢‡πá‡∏ô"; suggestion = "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏≥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏≠‡∏∞‡πÑ‡∏£‡∏°‡∏≤‡∏ö‡πâ‡∏≤‡∏á ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞ üåô"; } const suggestions = [ "‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏Ç‡∏¢‡∏±‡∏ö‡∏ï‡∏±‡∏ß ‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡∏ö‡πâ‡∏≤‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞ üí™", "‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏ï‡∏•‡∏≠‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞ üíß", "‡∏´‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡∏™‡∏≤‡∏¢‡∏ï‡∏≤‡∏ö‡πâ‡∏≤‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞ üëÄ", "‡∏ó‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞ üçé", "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏î‡∏µ ‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏´‡∏°‡∏Ñ‡∏∞? üö∂‚Äç‚ôÄÔ∏è" ]; if (hour < 12) { suggestion = suggestions[Math.floor(Math.random() * suggestions.length)]; } return `${timeOfDayGreeting} ‡∏Ñ‡∏∏‡∏ì${username}! ${suggestion}`; }

        // --- Fetch Health Data ---
        // (Copied - No changes needed)
        async function fetchHealthData(lineUserId) { stepsData.innerText = "Loading..."; hrData.innerText = "... BPM"; bmiData.innerText = "..."; lastSync.innerText = ""; stepsGoalPercent.innerText = "--%"; stepsProgressBar.style.width = "0%"; bmiCategory.innerText = "--"; bmiCategory.className = "text-gray-500 font-medium text-sm"; hrStatus.innerHTML = `<div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse"></div><span class="text-gray-500 text-sm font-medium">Loading...</span>`; try { console.log(`[LIFF] Fetching data for ${lineUserId}`); const response = await fetch(`${SERVER_URL}/api/get-dashboard-data?line_user_id=${lineUserId}`, { method: 'GET', headers: { 'ngrok-skip-browser-warning': 'true' } }); console.log(`[LIFF] Fetch response status: ${response.status}`); if (!response.ok) { const errorText = await response.text(); let errorData; try { errorData = JSON.parse(errorText); } catch (e) { console.error("[LIFF] Failed to parse error response as JSON:", errorText); errorData = { error: `Server error ${response.status}: ${errorText.substring(0, 100)}` }; } console.error("[LIFF] Fetch error:", errorData); updateConnectButton(false, response.status === 401 || response.status === 403 ? (errorData.error || "Please reconnect Google Fit") : `Server Error ${response.status}`); stepsData.innerText = "-"; hrData.innerText = "- BPM"; bmiData.innerText = "-"; hrStatus.innerHTML = `<div class="w-2 h-2 bg-red-400 rounded-full"></div><span class="text-red-500 text-sm font-medium">Error</span>`; bmiCategory.innerText = "Error"; bmiCategory.className = "text-red-500 font-medium text-sm"; return; } const data = await response.json(); console.log("[LIFF] Data received:", data); stepsData.innerText = data.totalSteps !== undefined ? data.totalSteps.toLocaleString() : "-"; const goalPercent = data.totalSteps !== undefined ? Math.min(Math.round((data.totalSteps / 10000) * 100), 100) : 0; stepsGoalPercent.innerText = `${goalPercent}%`; stepsProgressBar.style.width = `${goalPercent}%`; hrData.innerText = data.avgHeartRate !== undefined ? `${data.avgHeartRate} BPM` : "- BPM"; const hrStat = getHRStatus(data.avgHeartRate || 0); hrStatus.innerHTML = `<div class="w-2 h-2 ${hrStat.color} rounded-full ${data.avgHeartRate > 0 ? 'animate-pulse' : ''}"></div><span class="${hrStat.textColor} text-sm font-medium">${hrStat.text}</span>`; bmiData.innerText = data.bmi !== undefined ? data.bmi.toFixed(1) : "-"; const bmiCat = getBMICategory(data.bmi || 0); bmiCategory.innerText = bmiCat.text; bmiCategory.className = `${bmiCat.color} font-medium text-sm`; lastSync.innerText = `Updated ${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`; updateConnectButton(true); } catch (err) { console.error("[LIFF] Fetch Health Data Error (Catch Block):", err); stepsData.innerText = "-"; hrData.innerText = "- BPM"; bmiData.innerText = "-"; updateConnectButton(false, `Fetch Error`); connectSubtext.innerText = `Error: ${err.message}`; connectSubtext.className = "text-xs text-red-500 mt-2 text-center"; hrStatus.innerHTML = `<div class="w-2 h-2 bg-red-400 rounded-full"></div><span class="text-red-500 text-sm font-medium">Error</span>`; bmiCategory.innerText = "Error"; bmiCategory.className = "text-red-500 font-medium text-sm"; } }

        // --- Meditation Timer & Audio Logic ---
        // (Copied - No changes needed)
        function formatTime(seconds) { const mins = Math.floor(seconds / 60); const secs = seconds % 60; return `${mins}:${secs.toString().padStart(2, '0')}`; }
        function updateTimerUI() { meditationTimeLeft.innerText = formatTime(meditationTimeRemaining); const progress = ((meditationTimeTotal - meditationTimeRemaining) / meditationTimeTotal); const circumference = 2 * Math.PI * 88; meditationProgressCircle.style.strokeDashoffset = circumference * (1 - progress); if (meditationTimeRemaining <= 0) { meditationStatus.innerText = "Complete!"; } else { meditationStatus.innerText = meditationIsPlaying ? 'Meditating...' : 'Paused'; } }
        function startMeditationTimer() { if (meditationIsPlaying || meditationTimeRemaining <= 0) return; meditationIsPlaying = true; meditationStatus.innerText = 'Meditating...'; durationButtons.forEach(btn => btn.disabled = true); soundSelectButtons.forEach(btn => btn.disabled = true); breathingGuide.classList.remove('hidden'); meditationPlayIcon.classList.add('hidden'); meditationPauseIcon.classList.remove('hidden'); meditationPlayText.innerText = 'Pause'; startAudio(); meditationTimerInterval = setInterval(() => { meditationTimeRemaining--; updateTimerUI(); if (meditationTimeRemaining <= 0) { stopMeditationTimer(true); } }, 1000); }
        function stopMeditationTimer(isComplete = false) { clearInterval(meditationTimerInterval); meditationTimerInterval = null; meditationIsPlaying = false; meditationStatus.innerText = isComplete ? 'Complete!' : 'Paused'; breathingGuide.classList.add('hidden'); durationButtons.forEach(btn => btn.disabled = false); soundSelectButtons.forEach(btn => btn.disabled = false); meditationPlayIcon.classList.remove('hidden'); meditationPauseIcon.classList.add('hidden'); meditationPlayText.innerText = 'Start'; stopAudio(); if (isComplete) { if (navigator.vibrate) { console.log("[Vibrate] Timer finished, vibrating..."); navigator.vibrate(200); } else { console.log("[Vibrate] Vibration not supported."); } alert('Meditation session complete! Great job! üßò‚Äç‚ôÇÔ∏è'); } }
        function resetMeditationTimer() { stopMeditationTimer(); meditationTimeRemaining = meditationTimeTotal; updateTimerUI(); meditationStatus.innerText = 'Ready'; durationButtons.forEach(btn => btn.disabled = false); soundSelectButtons.forEach(btn => btn.disabled = false); }
        function selectMeditationDuration(duration) { if (meditationIsPlaying) return; meditationTimeTotal = duration; meditationTimeRemaining = duration; updateTimerUI(); durationButtons.forEach(btn => { if (parseInt(btn.dataset.duration) === duration) { btn.classList.add('control-button-active'); btn.classList.remove('control-button-inactive'); } else { btn.classList.remove('control-button-active'); btn.classList.add('control-button-inactive'); } }); console.log(`[Meditation] Duration set to ${duration / 60} minutes`); }
        function selectSound(soundType) { if (meditationIsPlaying) return; selectedSoundType = soundType; soundSelectButtons.forEach(btn => { if (btn.dataset.sound === soundType) { btn.classList.add('control-button-active'); btn.classList.remove('control-button-inactive'); } else { btn.classList.remove('control-button-active'); btn.classList.add('control-button-inactive'); } }); currentAudioPlayer = audioPlayers[selectedSoundType]; console.log(`[Audio] Sound selected: ${soundType}`); }
        
        // üëá ‚òÖ‚òÖ‚òÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] 2. ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô initializeAudio ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚òÖ‚òÖ‚òÖ
        function initializeAudio() {
            if (Object.keys(audioPlayers).length > 0) return;
            console.log("[Audio] Initializing Tone.js Players...");

            try {
                // ‚ùó‚ùó‚ùó ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏ü‡∏•‡πå .mp3 ‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‚ùó‚ùó‚ùó
                // ‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå (CORS)
                const songURLs = {
                    'song1': 'https://storage.googleapis.com/healthliff/song1.mp3', // <-- ‚ö†Ô∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç URL ‡∏ô‡∏µ‡πâ
                    'song2': 'https://storage.googleapis.com/healthliff/song2.mp3'  // <-- ‚ö†Ô∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç URL ‡∏ô‡∏µ‡πâ
                };

                const players = new Tone.Players(songURLs, () => {
                    // Callback ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏£‡πá‡∏à
                    console.log("[Audio] All songs loaded.");

                    // 3. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Player ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏±‡∏ß
                    const player1 = players.player('song1');
                    player1.loop = true; // ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ß‡∏ô‡∏ã‡πâ‡∏≥
                    player1.volume.value = -12; // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏á‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
                    audioPlayers['song1'] = player1; // ‡πÄ‡∏Å‡πá‡∏ö player ‡πÑ‡∏ß‡πâ

                    const player2 = players.player('song2');
                    player2.loop = true; // ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ß‡∏ô‡∏ã‡πâ‡∏≥
                    player2.volume.value = -12; // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏á‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
                    audioPlayers['song2'] = player2; // ‡πÄ‡∏Å‡πá‡∏ö player ‡πÑ‡∏ß‡πâ

                    // 4. ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Player ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏•‡∏≥‡πÇ‡∏û‡∏á
                    players.toDestination();
                    
                    // 5. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ
                    // (selectedSoundType ‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÑ‡∏ß‡πâ‡πÄ‡∏õ‡πá‡∏ô 'song1' ‡πÅ‡∏•‡πâ‡∏ß)
                    currentAudioPlayer = audioPlayers[selectedSoundType];
                    
                    console.log("[Audio] Players created and ready.");
                    updateMuteButtonUI();

                }).toDestination(); // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ï‡∏±‡∏ß‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏•‡∏≥‡πÇ‡∏û‡∏á

            } catch (e) {
                console.error("[Audio] Error creating Tone.js players:", e);
                btnAudioToggleMute.disabled = true;
                soundSelectButtons.forEach(btn => btn.disabled = true);
            }
        }

        // üëá ‚òÖ‚òÖ‚òÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] 3. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô startAudio (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ Transport) ‚òÖ‚òÖ‚òÖ
        function startAudio() {
            if (!currentAudioPlayer) {
                console.warn("[Audio] No audio player selected or player is not loaded yet.");
                if (Object.keys(audioPlayers).length === 0) {
                    initializeAudio(); // ‡∏•‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÇ‡∏´‡∏•‡∏î
                }
                return; 
            }

            if (!audioIsPlaying && isAudioContextStarted) {
                console.log(`[Audio] Starting playback for: ${selectedSoundType}`);
                currentAudioPlayer.start(); // <--- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å Transport
                audioIsPlaying = true;
            } else if (!isAudioContextStarted) {
                console.warn("[Audio] Cannot start audio - AudioContext not started by user yet.");
            } else if (!currentAudioPlayer) {
                console.error("[Audio] Cannot start audio - No player selected/initialized.");
            }
        }

        // üëá ‚òÖ‚òÖ‚òÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] 4. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô stopAudio (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ Transport) ‚òÖ‚òÖ‚òÖ
        function stopAudio() {
            if (audioIsPlaying && currentAudioPlayer) {
                console.log(`[Audio] Stopping playback for: ${selectedSoundType}`);
                currentAudioPlayer.stop(); // <--- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å Transport
                audioIsPlaying = false;
            }
        }
        
        function toggleAudioMute() { if (!isAudioContextStarted) { console.warn("[Audio] Cannot toggle mute - AudioContext not started."); return; } if (Object.keys(audioPlayers).length === 0) initializeAudio(); audioIsMuted = !audioIsMuted; Tone.Destination.mute = audioIsMuted; updateMuteButtonUI(); console.log(`[Audio] Mute toggled: ${audioIsMuted}`); }
        function updateMuteButtonUI() { if (audioIsMuted) { audioMuteIcon.classList.remove('hidden'); audioUnmuteIcon.classList.add('hidden'); } else { audioMuteIcon.classList.add('hidden'); audioUnmuteIcon.classList.remove('hidden'); } }

        // --- LIFF Initialization ---
        // (Copied - No changes needed)
        async function initializeLiff() { showLoading(); console.log("[LIFF] Initializing..."); try { await liff.init({ liffId: LIFF_ID }); console.log("[LIFF] Init success!"); if (!liff.isLoggedIn()) { console.log("[LIFF] Not logged in, showing login button."); showLogin(); } else { console.log("[LIFF] Logged in, showing app."); showApp(); const profile = await liff.getProfile(); console.log("[LIFF] Profile fetched:", profile); userPicture.src = profile.pictureUrl; userPicture.onerror = () => { userPicture.src='https://placehold.co/80x80/E5E7EB/A1A1AA?text=Err'; console.warn("[LIFF] Failed to load profile picture."); }; displayName.innerText = profile.displayName; userId.innerText = profile.userId; greetingMessage.innerText = generateGreeting(profile.displayName); console.log("[LIFF] Checking URL params..."); const processedRedirect = checkUrlParams(); if (!processedRedirect) { console.log("[LIFF] Not a redirect, fetching health data..."); await fetchHealthData(profile.userId); } else { console.log("[LIFF] Processed redirect, data fetch triggered by checkUrlParams."); } } } catch (e) { console.error("[LIFF] Init Error:", e); loadingState.innerHTML = `<p class="text-lg text-red-500">LIFF Initialization Failed: ${e.message}</p>`; showLoading(); } }

        // --- Check URL Params ---
        // (Copied - No changes needed)
        function checkUrlParams() { const params = new URLSearchParams(window.location.search); let processedParams = false; if (params.has('connect') && params.get('connect') === 'success') { console.log("[LIFF] Connect success param found."); updateConnectButton(true, "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•..."); processedParams = true; liff.getProfile().then(profile => { console.log("[LIFF] Fetching data after successful connect..."); fetchHealthData(profile.userId); }); } else if (params.has('error')) { const errorMsg = params.get('error'); console.log(`[LIFF] Connect error param found: ${errorMsg}`); updateConnectButton(false, `Connection failed: ${errorMsg}`); processedParams = true; } if (processedParams) { console.log("[LIFF] Clearing URL params."); window.history.replaceState({}, document.title, window.location.pathname); } return processedParams; }

        // --- Event Listeners ---
        // (Copied - No changes needed)
        btnLogin.addEventListener("click", () => { console.log("[LIFF] Login button clicked."); liff.login({ redirectUri: window.location.href }); }); btnLogout.addEventListener("click", () => { if (liff.isLoggedIn()) { console.log("[LIFF] Logout button clicked."); if (confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) { console.log("[LIFF] Logging out..."); liff.logout(); window.location.reload(); } else { console.log("[LIFF] Logout cancelled."); } } }); btnConnectHealth.addEventListener("click", async () => { if (btnConnectHealth.disabled) return; console.log("[LIFF] Connect Health button clicked."); btnConnectHealth.disabled = true; connectText.innerText = "Connecting..."; connectPulse.classList.add('hidden'); try { const profile = await liff.getProfile(); const lineUserId = profile.userId; const authUrl = `${SERVER_URL}/auth/google/start?line_user_id=${lineUserId}`; console.log(`[LIFF] Starting auth flow for ${lineUserId} at ${authUrl}`); if (liff.isInClient()) { console.log("[LIFF] Opening external window for auth."); alert("‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô Google..."); liff.openWindow({ url: authUrl, external: true }); } else { console.log("[LIFF] Redirecting in current window for auth."); window.location.href = authUrl; } } catch (err) { console.error("[LIFF] Error starting auth flow:", err); alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: " + err.message); updateConnectButton(false, "Connection Error"); } }); btnMedication.addEventListener("click", () => { console.log("[LIFF] Medication button clicked."); openModal('medicationModal'); }); btnMeditation.addEventListener("click", async () => { console.log("[LIFF] Meditation button clicked."); if (!isAudioContextStarted && Tone.context.state !== 'running') { try { await Tone.start(); console.log('[Audio] AudioContext started by button click.'); isAudioContextStarted = true; initializeAudio(); } catch (e) { console.error("[Audio] Failed to start AudioContext:", e); alert("Could not start audio."); return; } } selectSound(selectedSoundType); selectMeditationDuration(meditationTimeTotal); openModal('mediditationModal'); }); btnMeditationTogglePlay.addEventListener('click', () => { if (meditationIsPlaying) { stopMeditationTimer(); } else { if (!isAudioContextStarted) { Tone.start().then(() => { console.log('[Audio] AudioContext started by Play button.'); isAudioContextStarted = true; initializeAudio(); startMeditationTimer(); }).catch(e => console.error("[Audio] Failed to start AudioContext on Play:", e)); } else { startMeditationTimer(); } } }); btnMeditationReset.addEventListener('click', resetMeditationTimer); durationButtons.forEach(button => { button.addEventListener('click', () => { const duration = parseInt(button.dataset.duration); selectMeditationDuration(duration); }); }); soundSelectButtons.forEach(button => { button.addEventListener('click', () => { const soundType = button.dataset.sound; selectSound(soundType); }); }); btnAudioToggleMute.addEventListener('click', toggleAudioMute);

        // --- Run ---
        document.addEventListener("DOMContentLoaded", initializeLiff);

    </script>
    </body>
</html>














