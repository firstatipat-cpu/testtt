<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CareBuddy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+Thai:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans Thai', 'Inter', sans-serif; }
        .modal { display: none; }
        .modal.is-open { display: flex; opacity: 1; pointer-events: auto; }
        .modal.is-closing { opacity: 0; pointer-events: none; }
        .modal .modal-content { transform: scale(0.95); transition: transform 0.2s ease-out, opacity 0.2s ease-out; }
        .modal.is-open .modal-content { transform: scale(1); }
        .bg-gradient-pink-rose { background-image: linear-gradient(to bottom right, #EC4899, #F43F5E); }
        .hover\:bg-gradient-pink-rose-dark:hover { background-image: linear-gradient(to bottom right, #DB2777, #E11D48); }
        .bg-gradient-indigo-purple { background-image: linear-gradient(to bottom right, #6366F1, #A855F7); }
        .hover\:bg-gradient-indigo-purple-dark:hover { background-image: linear-gradient(to bottom right, #4F46E5, #9333EA); }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #059669; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .control-button-active { background-color: #8B5CF6 !important; color: white !important; border-color: transparent !important; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);}
        .control-button-inactive { background-color: #F3F4F6; color: #4B5563; border-color: transparent; }
        .control-button-inactive:hover:not(:disabled) { background-color: #E5E7EB; }
        #meditationProgressCircle { transition: stroke-dashoffset 1s linear; }
        #meditationGradient stop[offset="0%"] { stop-color: #8B5CF6; }
        #meditationGradient stop[offset="100%"] { stop-color: #6366F1; }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen">

    <div class="container mx-auto px-4 py-6 max-w-md">

        <div id="loadingState" class="flex flex-col items-center justify-center min-h-[70vh] text-center p-10">
            <div class="spinner mb-4"></div>
            <p class="text-lg text-gray-500">กำลังโหลด...</p>
        </div>

        <div id="loginState" class="hidden text-center p-10 bg-white rounded-xl shadow-lg mt-10">
            <h1 class="text-2xl font-semibold text-green-600 mb-2">LINE Health App</h1>
            <p class="text-gray-600 mb-6">กรุณาล็อกอินด้วยบัญชี LINE ของคุณ</p>
            <button id="btnLogin" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition duration-200">
                เข้าสู่ระบบด้วย LINE
            </button>
        </div>

        <div id="appState" class="hidden space-y-6">

            <div class="mb-4">
                <h1 class="text-2xl font-semibold text-green-600 mb-1">LINE Health App</h1>
                <p class="text-gray-600">Track your health with Google Fit</p>
            </div>

            <div id="greetingSection" class="bg-white rounded-xl p-4 shadow text-center mb-6">
                <p id="greetingMessage" class="text-gray-700">...</p>
            </div>

            <div id="profileSection" class="bg-white rounded-2xl p-6 shadow-lg">
                 <div class="flex items-center gap-4">
                     <img id="userPicture" class="w-20 h-20 rounded-full border-4 border-green-100 object-cover bg-gray-100 flex-shrink-0" src="https://placehold.co/80x80/E5E7EB/A1A1AA?text=?" alt="User Picture" onerror="this.onerror=null; this.src='https://placehold.co/80x80/E5E7EB/A1A1AA?text=Err';">
                     <div class="flex-1 min-w-0">
                         <h2 id="displayName" class="text-xl font-semibold text-gray-900 mb-1 truncate">...</h2>
                         <p class="text-xs text-gray-500 break-all">
                             ID: <span id="userId">...</span>
                         </p>
                     </div>
                     <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center flex-shrink-0">
                         <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                             <path d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63h2.386c.346 0 .627.285.627.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.105.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345 0 .63.285.63.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63.346 0 .628.285.628.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.63 0 .344-.282.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314"/>
                         </svg>
                     </div>
                 </div>
            </div>

            <div id="connectSection" class="mb-6">
                <button id="btnConnectHealth" class="w-full bg-white rounded-xl p-4 shadow-md hover:shadow-lg transition-shadow flex items-center justify-center gap-3 text-gray-700 font-medium disabled:opacity-70 disabled:cursor-not-allowed">
                    <svg class="w-6 h-6" fill="#428df5" viewBox="0 0 24 24" role="img" xmlns="http://www.w3.org/2000/svg">
                            <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                            <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                            <g id="SVGRepo_iconCarrier">
                                <path d="M23.218 4.868c-1.235-2.194-3.927-3.356-6.378-2.843-1.11.243-2.173.774-2.979 1.583-.622.613-1.242 1.229-1.864 1.841-.915-.91-1.788-1.937-2.882-2.648a5.98 5.98 0 0 0-3.904-.845c-4.757.578-6.936 6.346-3.615 9.85 3.481 3.418 6.937 6.863 10.413 10.288 3.291-3.251 6.573-6.51 9.871-9.752 2.132-1.831 2.8-5.026 1.338-7.474zM6.162 11.223c-.692-.755-1.511-1.404-2.141-2.208-.821-1.218-.158-3.012 1.26-3.397.781-.256 1.683-.031 2.279.527.627.609 1.236 1.237 1.866 1.843l.005.006a414.706 414.706 0 0 0-3.269 3.229zm5.846 5.758a3300.079 3300.079 0 0 1-3.255-3.22c2.555-2.516 5.103-5.042 7.65-7.566.393-.394.93-.646 1.487-.673 2.086-.154 3.285 2.372 1.801 3.866-2.549 2.542-5.121 5.062-7.683 7.593z"></path>
                            </g>
                        </svg>
                    <span id="connectText">Connect to Google Fit</span>
                    <div id="connectPulse" class="w-3 h-3 bg-green-500 rounded-full animate-pulse hidden ml-2 flex-shrink-0"></div>
                </button>
                <p id="connectSubtext" class="text-xs text-gray-500 mt-2 text-center"></p>
            </div>

            <div id="dashboardSection" class="space-y-4">
                 <div class="flex items-center justify-between mb-2">
                     <h3 class="text-lg font-semibold text-gray-900">Your Health Metrics</h3>
                     <span id="lastSync" class="text-gray-400 text-xs"></span>
                 </div>
                 <div class="bg-white rounded-xl p-6 shadow-md border-0 hover:shadow-lg transition-shadow">
                     <div class="flex items-center justify-between mb-4">
                         <div class="flex items-center gap-4 min-w-0">
                             <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center flex-shrink-0">
                                 <svg class="w-8 h-8" viewBox="-97 0 512 512" version="1.1" xmlns="http://www.w3.org/2000/svg" fill="#0084ff" stroke="#0084ff"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"><path fill="" d="M68.822,394.263l21.259,-49.604l51.65,51.65l-16.93,34.695c-1.613,3.306 -3.784,6.309 -6.418,8.877l-63.912,62.324c-12.504,12.193 -32.56,12.023 -44.961,-0.275c-12.627,-12.523 -12.708,-33.027 -0.073,-45.543l52.492,-51.994c2.929,-2.901 5.269,-6.341 6.893,-10.13Zm25.076,-180.83l26.489,-10.52l-18.105,82.627c-1.075,4.907 0.217,10.035 3.489,13.846l0.28,0.326l53.312,60.288l-0.167,0.517l0.224,-0.46l32.816,44.244c2.456,3.31 4.249,7.065 5.28,11.056l18.488,71.534c4.45,17.218 22.205,27.473 39.384,22.87c16.869,-4.52 27.116,-21.762 22.878,-38.705l-21.323,-85.252c-1.111,-4.444 -3.163,-8.597 -6.018,-12.179l-54.38,-68.24l16.859,-65.748l9.711,25.748c2.123,5.629 5.789,10.546 10.579,14.186l33.912,25.773c14.026,10.66 34.04,7.965 44.762,-6.013c10.783,-14.057 8.104,-34.213 -5.99,-44.947l-25.107,-19.123c-4.523,-3.445 -8.047,-8.033 -10.208,-13.292l-21.681,-52.748c-2.806,-6.826 -7.906,-12.036 -14.053,-15.086l0.034,-0.135c0,0 -25.696,-17.436 -44.5,-22.5c-19.553,-5.265 -50.639,-1.941 -54.17,-1.538c-3.94,-0.014 -7.947,0.704 -11.834,2.238l-72.866,28.762c-1.72,0.679 -3.217,1.821 -4.327,3.299l-33.134,44.146c-10.593,14.114 -7.735,34.159 6.357,44.782c14.112,10.639 34.204,7.844 44.842,-6.268l21.296,-28.249c1.767,-2.343 4.144,-4.155 6.871,-5.239Zm105.465,-101.433c30.928,0 56,-25.072 56,-56c0,-30.928 -25.072,-56 -56,-56c-30.928,0 -56,25.072 -56,56c0,30.928 25.072,56 56,56Z"></path></g></svg>
                             </div>
                             <div class="min-w-0">
                                 <p class="text-sm text-gray-500 truncate">Steps Today</p>
                                 <p id="stepsData" class="text-xl font-semibold text-gray-900 truncate">...</p>
                             </div>
                         </div>
                         <div class="text-right flex-shrink-0 ml-2">
                             <div id="stepsGoalPercent" class="text-blue-600 text-sm font-medium">--%</div>
                             <div class="text-gray-400 text-xs">of 10K goal</div>
                         </div>
                     </div>
                     <div class="bg-gray-100 rounded-full h-2 overflow-hidden">
                         <div id="stepsProgressBar" class="bg-blue-500 h-full transition-all duration-500" style="width: 0%"></div>
                     </div>
                 </div>
                 <div class="bg-white rounded-xl p-6 shadow-md border-0 hover:shadow-lg transition-shadow">
                       <div class="flex items-center justify-between">
                           <div class="flex items-center gap-4 min-w-0">
                               <div class="w-12 h-12 bg-red-100 rounded-xl flex items-center justify-center flex-shrink-0">
                                   <svg viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg" fill="#ff0000" stroke="#ff0000"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"><path d="m0 6.5h2l2.5-6 2 12 3-9 2.095 6 1.405-3h2" fill="none" stroke="" stroke-linecap="round" stroke-linejoin="round" transform="translate(3 4)"></path></g></svg>
                               </div>
                               <div class="min-w-0">
                                   <p class="text-sm text-gray-500 truncate">Heart Rate (Avg)</p>
                                   <p id="hrData" class="text-xl font-semibold text-gray-900 truncate">... <span class="text-xs font-normal">BPM</span></p>
                               </div>
                           </div>
                           <div id="hrStatus" class="flex items-center gap-2 flex-shrink-0 ml-2">
                                <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
                               <span class="text-gray-500 text-sm font-medium">--</span>
                           </div>
                       </div>
                  </div>
                 <div class="bg-white rounded-xl p-6 shadow-md border-0 hover:shadow-lg transition-shadow">
                       <div class="flex items-center justify-between">
                           <div class="flex items-center gap-4 min-w-0">
                               <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center flex-shrink-0">
                                   <svg class="w-8 h-8" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" xml:space="preserve" fill="#000000"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path style="fill:#5f4294;" d="M0,468.598v-98.869c0-7.062,5.297-12.359,12.359-12.359h481.986c9.71,0,17.655,7.945,17.655,17.655 v88.276c0,9.71-7.945,17.655-17.655,17.655H12.359C5.297,480.956,0,475.66,0,468.598"></path> <g> <path style="fill:#a179ec;" d="M61.793,445.646c14.124,0,26.483-11.476,26.483-26.483c0-14.124-11.476-26.483-26.483-26.483 S35.31,404.156,35.31,419.163C35.31,433.287,47.669,445.646,61.793,445.646"></path> <path style="fill:#a179ec;" d="M194.207,357.37v35.31c0,5.297,3.531,8.828,8.828,8.828s8.828-3.531,8.828-8.828v-35.31H194.207z"></path> <path style="fill:#a179ec;" d="M158.897,357.37v52.966c0,5.297,3.531,8.828,8.828,8.828s8.828-3.531,8.828-8.828V357.37H158.897z"></path> <path style="fill:#a179ec;" d="M229.517,357.37v52.966c0,5.297,3.531,8.828,8.828,8.828s8.828-3.531,8.828-8.828V357.37H229.517z"></path> <path style="fill:#a179ec;" d="M123.586,357.37v35.31c0,5.297,3.531,8.828,8.828,8.828c5.297,0,8.828-3.531,8.828-8.828v-35.31 H123.586z"></path> <path style="fill:#a179ec;" d="M8.828,136.68l413.131,357.517c7.945,7.062,21.186,6.179,27.366-2.648l59.145-70.621 c4.414-5.297,3.531-12.359-1.766-16.772L188.91,136.68H8.828z"></path> </g> <path style="fill:#5f4294;" d="M0,124.322V25.453c0-7.062,5.297-12.359,12.359-12.359h481.986c9.71,0,17.655,7.945,17.655,17.655 v88.276c0,9.71-7.945,17.655-17.655,17.655H12.359C5.297,136.68,0,131.384,0,124.322"></path> <path style="fill:#a179ec;" d="M61.793,101.37c14.124,0,26.483-11.476,26.483-26.483S76.8,48.405,61.793,48.405 S35.31,60.763,35.31,74.887S47.669,101.37,61.793,101.37"></path> <path style="fill:#5f4294;" d="M446.676,399.743c-11.476-9.71-27.366-7.945-37.076,3.531c-9.71,11.476-7.945,27.366,3.531,37.076 c11.476,9.71,27.366,7.945,37.076-3.531C459.034,425.343,458.152,408.57,446.676,399.743"></path> <g> <path style="fill:#a179ec;" d="M441.379,13.094V66.06c0,5.297,3.531,8.828,8.828,8.828c5.297,0,8.828-3.531,8.828-8.828V13.094 H441.379z"></path> <path style="fill:#a179ec;" d="M406.069,13.094v35.31c0,5.297,3.531,8.828,8.828,8.828s8.828-3.531,8.828-8.828v-35.31H406.069z"></path> <path style="fill:#a179ec;" d="M370.759,13.094V66.06c0,5.297,3.531,8.828,8.828,8.828s8.828-3.531,8.828-8.828V13.094H370.759z"></path> <path style="fill:#a179ec;" d="M335.448,13.094v35.31c0,5.297,3.531,8.828,8.828,8.828s8.828-3.531,8.828-8.828v-35.31H335.448z"></path> <path style="fill:#a179ec;" d="M300.138,13.094V66.06c0,5.297,3.531,8.828,8.828,8.828s8.828-3.531,8.828-8.828V13.094H300.138z"></path> <path style="fill:#a179ec;" d="M264.828,13.094v35.31c0,5.297,3.531,8.828,8.828,8.828c5.297,0,8.828-3.531,8.828-8.828v-35.31 H264.828z"></path> <path style="fill:#a179ec;" d="M229.517,13.094V66.06c0,5.297,3.531,8.828,8.828,8.828s8.828-3.531,8.828-8.828V13.094H229.517z"></path> <path style="fill:#a179ec;" d="M194.207,13.094v35.31c0,5.297,3.531,8.828,8.828,8.828s8.828-3.531,8.828-8.828v-35.31H194.207z"></path> <path style="fill:#a179ec;" d="M158.897,13.094V66.06c0,5.297,3.531,8.828,8.828,8.828s8.828-3.531,8.828-8.828V13.094H158.897z"></path> <path style="fill:#a179ec;" d="M123.586,13.094v35.31c0,5.297,3.531,8.828,8.828,8.828c5.297,0,8.828-3.531,8.828-8.828v-35.31 H123.586z"></path> </g> <g> <path style="fill:#5f4294;" d="M90.041,207.301L90.041,207.301l18.538-22.952c2.648-3.531,2.648-9.71-1.766-12.359 c-3.531-2.648-9.71-2.648-12.359,0.883L76.8,194.943L90.041,207.301z"></path> <path style="fill:#5f4294;" d="M116.524,229.37L116.524,229.37l30.014-36.193c3.531-3.531,2.648-9.71-0.883-12.359 c-3.531-3.531-9.71-2.648-12.359,0.883l-30.014,36.193L116.524,229.37z"></path> <path style="fill:#5f4294;" d="M143.007,253.205L143.007,253.205l19.421-22.952c3.531-3.531,2.648-9.71-0.883-12.359 c-3.531-3.531-9.71-2.648-12.359,0.883l-19.421,22.952L143.007,253.205z"></path> <path style="fill:#5f4294;" d="M187.145,227.605l-30.897,37.076l13.241,11.476l0,0l30.897-37.076 c3.531-3.531,2.648-9.71-0.883-12.359C195.972,223.191,190.676,224.074,187.145,227.605"></path> <path style="fill:#5f4294;" d="M203.034,263.798l-19.421,23.834l13.241,11.476l0,0l19.421-23.835 c3.531-3.531,2.648-9.71-0.883-12.359C211.862,259.384,206.566,260.267,203.034,263.798"></path> <path style="fill:#5f4294;" d="M241.876,273.508l-31.779,37.076l13.241,11.476l0,0l31.779-37.959 c3.531-3.531,2.648-9.71-0.883-12.359C250.703,269.094,244.524,269.094,241.876,273.508"></path> <path style="fill:#5f4294;" d="M256.883,309.701l-20.303,24.717l13.241,11.476l0,0l20.303-24.717 c3.531-3.531,2.648-9.71-0.883-12.359C265.71,305.287,260.414,305.287,256.883,309.701"></path> <path style="fill:#5f4294;" d="M295.724,318.529l-31.779,37.959l13.241,11.476l0,0l31.779-37.959 c3.531-3.531,2.648-9.71-0.883-12.359C304.552,314.115,298.372,314.998,295.724,318.529"></path> <path style="fill:#5f4294;" d="M311.614,354.722l-21.186,24.717l13.241,11.476l0,0l21.186-25.6 c3.531-3.531,2.648-9.71-0.883-12.359C320.441,350.308,314.262,351.191,311.614,354.722"></path> <path style="fill:#5f4294;" d="M349.572,363.549l-32.662,38.841l13.241,11.476l0,0l32.662-38.841 c3.531-3.531,2.648-9.71-0.883-12.359C358.4,360.018,353.103,360.018,349.572,363.549"></path> </g> </g></svg>
                               </div>
                               <div class="min-w-0">
                                   <p class="text-sm text-gray-500 truncate">Body Mass Index</p>
                                   <p id="bmiData" class="text-xl font-semibold text-gray-900 truncate">...</p>
                               </div>
                           </div>
                           <div class="text-right flex-shrink-0 ml-2">
                                <span id="bmiCategory" class="text-gray-500 font-medium text-sm">--</span>
                      _hidden">
                <p class="text-gray-700 mb-1 font-medium">Breathing Guide</p>
                <p class="text-gray-600 text-sm">หายใจเข้า 4 วิ, กลั้นหายใจ 4 วิ, หายใจออก 4 วิ</p>
            </div>
         </div>
    </div>
    <script>
        const loadingState = document.getElementById("loadingState"); const loginState = document.getElementById("loginState"); const appState = document.getElementById("appState"); const btnLogin = document.getElementById("btnLogin"); const btnLogout = document.getElementById("btnLogout"); const btnConnectHealth = document.getElementById("btnConnectHealth"); const userPicture = document.getElementById("userPicture"); const displayName = document.getElementById("displayName"); const userId = document.getElementById("userId"); const greetingMessage = document.getElementById("greetingMessage"); const connectText = document.getElementById("connectText"); const connectSubtext = document.getElementById("connectSubtext"); const connectPulse = document.getElementById("connectPulse"); const lastSync = document.getElementById("lastSync"); const stepsData = document.getElementById("stepsData"); const stepsGoalPercent = document.getElementById("stepsGoalPercent"); const stepsProgressBar = document.getElementById("stepsProgressBar"); const hrData = document.getElementById("hrData"); const hrStatus = document.getElementById("hrStatus"); const bmiData = document.getElementById("bmiData"); const bmiCategory = document.getElementById("bmiCategory"); const btnMedication = document.getElementById("btnMedication"); const btnMeditation = document.getElementById("btnMeditation"); const medicationModal = document.getElementById("medicationModal"); const meditationModal = document.getElementById("meditationModal"); const meditationTimeLeft = document.getElementById("meditationTimeLeft"); const meditationStatus = document.getElementById("meditationStatus"); const meditationProgressCircle = document.getElementById("meditationProgressCircle"); const durationButtons = document.querySelectorAll(".meditation-duration-btn"); const btnMeditationTogglePlay = document.getElementById("btnMeditationTogglePlay"); const meditationPlayIcon = document.getElementById("meditationPlayIcon"); const meditationPauseIcon = document.getElementById("meditationPauseIcon"); const meditationPlayText = document.getElementById("meditationPlayText"); const btnMeditationReset = document.getElementById("btnMeditationReset"); const breathingGuide = document.getElementById("breathingGuide"); const btnAudioToggleMute = document.getElementById("btnAudioToggleMute"); const audioMuteIcon = document.getElementById("audioMuteIcon"); const audioUnmuteIcon = document.getElementById("audioUnmuteIcon"); const soundSelectButtons = document.querySelectorAll(".sound-select-btn");

        const LIFF_ID = "2008337931-z1xeJb7D"; 
        const SERVER_URL = "https://sequential-seborrheal-clelia.ngrok-free.dev"; 

        
        let meditationTimerInterval = null; let meditationIsPlaying = false; let meditationTimeTotal = 180; let meditationTimeRemaining = 180; let audioPlayers = {}; let currentAudioPlayer = null; let selectedSoundType = 'song1'; let audioIsPlaying = false; let audioIsMuted = false; let isAudioContextStarted = false;

        function showLoading() { loadingState.style.display = "flex"; loginState.style.display = "none"; appState.style.display = "none"; } function showLogin() { loadingState.style.display = "none"; loginState.style.display = "block"; appState.style.display = "none"; } function showApp() { loadingState.style.display = "none"; loginState.style.display = "none"; appState.style.display = "block"; } function updateConnectButton(connected, message = null) { if (connected) { connectText.innerText = "Connected"; btnConnectHealth.classList.add("bg-green-100", "text-green-700", "cursor-not-allowed"); btnConnectHealth.classList.remove("bg-white", "hover:shadow-lg"); btnConnectHealth.disabled = true; connectPulse.classList.remove("hidden"); connectSubtext.innerText = message || `Last sync: ${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`; connectSubtext.className = "text-xs text-green-600 mt-2 text-center"; } else { connectText.innerText = "Connect to Google Fit"; btnConnectHealth.classList.remove("bg-green-100", "text-green-700", "cursor-not-allowed"); btnConnectHealth.classList.add("bg-white", "hover:shadow-lg"); btnConnectHealth.disabled = false; connectPulse.classList.add("hidden"); connectSubtext.innerText = message || "เชื่อมต่อเพื่อซิงค์ข้อมูล"; connectSubtext.className = `text-xs mt-2 text-center ${message ? 'text-red-500' : 'text-gray-500'}`; } } function getBMICategory(bmi) { if (bmi <= 0) return { text: "--", color: "text-gray-500" }; if (bmi < 18.5) return { text: "Underweight", color: "text-blue-600" }; if (bmi < 25) return { text: "Normal", color: "text-green-600" }; if (bmi < 30) return { text: "Overweight", color: "text-orange-600" }; return { text: "Obese", color: "text-red-600" }; } function getHRStatus(hr) { if (hr <= 0) return { text: "--", color: "bg-gray-400", textColor: "text-gray-500" }; if (hr < 60) return { text: "Resting", color: "bg-blue-500", textColor: "text-blue-600" }; if (hr <= 100) return { text: "Normal", color: "bg-green-500", textColor: "text-green-600" }; return { text: "Elevated", color: "bg-red-500", textColor: "text-red-600" }; }

        function openModal(modalId) { const modal = document.getElementById(modalId); if (modal) { modal.classList.add('is-open'); void modal.offsetWidth; modal.classList.add('opacity-100', 'pointer-events-auto'); modal.querySelector('.modal-content').classList.add('scale-100'); modal.querySelector('.modal-content').classList.remove('scale-95'); if (modalId === 'meditationModal') { resetMeditationTimer(); selectSound(selectedSoundType); selectMeditationDuration(meditationTimeTotal); initializeAudio(); updateMuteButtonUI(); } } } function closeModal(modalId) { const modal = document.getElementById(modalId); if (modal && modal.classList.contains('is-open')) { modal.classList.add('is-closing'); modal.classList.remove('opacity-100', 'pointer-events-auto'); modal.querySelector('.modal-content').classList.remove('scale-100'); modal.querySelector('.modal-content').classList.add('scale-95'); if (modalId === 'meditationModal') { stopMeditationTimer(); stopAudio(); } setTimeout(() => { modal.classList.remove('is-open', 'is-closing'); }, 200); } } window.addEventListener('click', (event) => { if (event.target.classList.contains('modal')) { Array.from(document.querySelectorAll('.modal.is-open')).forEach(modal => { closeModal(modal.id); }); } });

        function generateGreeting(username){const lateNightSuggestions=["ยังไม่นอนอีกเหรอคะ? พักผ่อนบ้างนะคะ 😴","ดึกแล้ว หาอะไรอุ่นๆ ดื่มก่อนนอนไหมคะ? 🥛","ถ้ายังนอนไม่หลับ ลองฟังเพลงเบาๆ หรือนั่งสมาธิดูนะคะ 🧘","อย่าลืมตั้งนาฬิกาปลุกสำหรับพรุ่งนี้นะคะ ⏰"];const morningSuggestions=["เริ่มต้นวันดีๆ นะคะ ขอให้เป็นวันที่สดใสค่ะ ☀️","อย่าลืมลุกมาขยับตัว ออกกำลังกายบ้างนะคะ 💪","ทานมื้อเช้าที่มีประโยชน์ เติมพลังสำหรับวันนี้นะคะ 🥞","จิบกาแฟ หรือเครื่องดื่มอุ่นๆ สักแก้วนะคะ ☕","เช้านี้อากาศดี สูดหายใจลึกๆ นะคะ 🌬️","วางแผนเล็กๆ สำหรับวันนี้ จะได้ลุล่วงไปได้ด้วยดีค่ะ 📝","วันนี้ตั้งเป้าหมายเล็กๆ สัก 1 อย่างดูไหมคะ? 🎯","ตรวจเช็คตารางงาน/นัดหมายสั้นๆ ของวันนะคะ 🗓️"];const afternoonSuggestions=["ดื่มน้ำให้เพียงพอตลอดวันนะคะ 💧","หาเวลาพักผ่อนสายตาบ้างนะคะ 👀","พักทานของว่างเบาๆ เติมพลังช่วงบ่ายไหมคะ 🥨","ลองหายใจลึกๆ สัก 3-4 ครั้ง ผ่อนคลายดูนะคะ 🌬️","นั่งตัวตรง ยืดหลังสักหน่อย ป้องกันออฟฟิศซินโดรมค่ะ 🧍","ฟังเพลงที่ชอบสักเพลง เพิ่มพลังบวกนะคะ 🎶","จัดโต๊ะให้โล่งๆ สบายตา ช่วยให้ทำงานลื่นขึ้นนะคะ ✨","ช่วงบ่ายอาจจะล้า ลองหาอะไรหวานๆ (น้อยๆ) ทานดูนะคะ 🍬","อีกนิดเดียวก็เลิกงาน/หมดวันแล้ว สู้ๆ ค่ะ 🔥"];const eveningSuggestions=["วันนี้ทำกิจกรรมอะไรมาบ้าง อย่าลืมพักผ่อนนะคะ 🌙","ทานมื้อเย็นให้อร่อยนะคะ 🍲","พักผ่อนสายตาจากหน้าจอบ้างนะคะ 📵","ใช้เวลาดีๆ กับครอบครัวหรือคนที่คุณรักนะคะ ❤️","เตรียมตัวพักผ่อน พรุ่งนี้จะได้สดใสนะคะ 😴","ลองนึกถึงเรื่องดีๆ ที่เกิดขึ้นวันนี้ 1 อย่างนะคะ 🙏","อ่านหนังสือดีๆ สักเล่มก่อนนอนไหมคะ? 📖","วันนี้เป็นยังไงบ้าง? เหนื่อยมาทั้งวันแล้ว พักผ่อนเต็มที่นะคะ 🛀"];const now=new Date();const hour=now.getHours();const day=now.getDay();const isWeekend=(day===0||day===6);let timeOfDayGreeting="";let currentSuggestions=[];if(hour<5){timeOfDayGreeting="สวัสดีตอนดึก";currentSuggestions=[...lateNightSuggestions];}else if(hour<12){timeOfDayGreeting="สวัสดีตอนเช้า";currentSuggestions=[...morningSuggestions];if(isWeekend){currentSuggestions=currentSuggestions.filter(s=>s!=="ตรวจเช็คตารางงาน/นัดหมายสั้นๆ ของวันนะคะ 🗓️");currentSuggestions.push("สวัสดีวันหยุดค่ะ! พักผ่อนให้เต็มที่นะคะ 🏖️");}else{if(day===1)currentSuggestions.push("เริ่มต้นสัปดาห์อย่างสดใสนะคะ 💼");}}else if(hour<18){timeOfDayGreeting="สวัสดีตอนบ่าย";currentSuggestions=[...afternoonSuggestions];if(isWeekend){currentSuggestions=currentSuggestions.filter(s=>s!=="อีกนิดเดียวก็เลิกงาน/หมดวันแล้ว สู้ๆ ค่ะ 🔥");currentSuggestions.push("ใช้เวลาช่วงบ่ายวันหยุดให้สนุกนะคะ ☀️");}else{if(day===5)currentSuggestions.push("Happy Friday! อีกนิดเดียวก็ได้พักแล้ว 🚀");}}else{timeOfDayGreeting="สวัสดีตอนเย็น";currentSuggestions=[...eveningSuggestions];if(day===0){currentSuggestions.push("พรุ่งนี้วันจันทร์แล้ว พักผ่อนเต็มที่นะคะ 😴");}else if(day===6){currentSuggestions.push("พรุ่งนี้ก็ยังเป็นวันหยุด! พักผ่อนให้เต็มที่ค่ะ 🎉");}}const suggestion=currentSuggestions[Math.floor(Math.random()*currentSuggestions.length)];return `${timeOfDayGreeting} คุณ${username}! ${suggestion}`;}
        async function fetchHealthData(lineUserId) { stepsData.innerText = "Loading..."; hrData.innerText = "... BPM"; bmiData.innerText = "..."; lastSync.innerText = ""; stepsGoalPercent.innerText = "--%"; stepsProgressBar.style.width = "0%"; bmiCategory.innerText = "--"; bmiCategory.className = "text-gray-500 font-medium text-sm"; hrStatus.innerHTML = `<div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse"></div><span class="text-gray-500 text-sm font-medium">Loading...</span>`; try { console.log(`[LIFF] Fetching data for ${lineUserId}`); const response = await fetch(`${SERVER_URL}/api/get-dashboard-data?line_user_id=${lineUserId}`, { method: 'GET', headers: { 'ngrok-skip-browser-warning': 'true' } }); console.log(`[LIFF] Fetch response status: ${response.status}`); if (!response.ok) { const errorText = await response.text(); let errorData; try { errorData = JSON.parse(errorText); } catch (e) { console.error("[LIFF] Failed to parse error response as JSON:", errorText); errorData = { error: `Server error ${response.status}: ${errorText.substring(0, 100)}` }; } console.error("[LIFF] Fetch error:", errorData); updateConnectButton(false, response.status === 401 || response.status === 403 ? (errorData.error || "Please reconnect Google Fit") : `Server Error ${response.status}`); stepsData.innerText = "-"; hrData.innerText = "- BPM"; bmiData.innerText = "-"; hrStatus.innerHTML = `<div class="w-2 h-2 bg-red-400 rounded-full"></div><span class="text-red-500 text-sm font-medium">Error</span>`; bmiCategory.innerText = "Error"; bmiCategory.className = "text-red-500 font-medium text-sm"; return; } const data = await response.json(); console.log("[LIFF] Data received:", data); stepsData.innerText = data.totalSteps !== undefined ? data.totalSteps.toLocaleString() : "-"; const goalPercent = data.totalSteps !== undefined ? Math.min(Math.round((data.totalSteps / 10000) * 100), 100) : 0; stepsGoalPercent.innerText = `${goalPercent}%`; stepsProgressBar.style.width = `${goalPercent}%`; hrData.innerText = data.avgHeartRate !== undefined ? `${data.avgHeartRate} BPM` : "- BPM"; const hrStat = getHRStatus(data.avgHeartRate || 0); hrStatus.innerHTML = `<div class="w-2 h-2 ${hrStat.color} rounded-full ${data.avgHeartRate > 0 ? 'animate-pulse' : ''}"></div><span class="${hrStat.textColor} text-sm font-medium">${hrStat.text}</span>`; bmiData.innerText = data.bmi !== undefined ? data.bmi.toFixed(1) : "-"; const bmiCat = getBMICategory(data.bmi || 0); bmiCategory.innerText = bmiCat.text; bmiCategory.className = `${bmiCat.color} font-medium text-sm`; lastSync.innerText = `Updated ${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`; updateConnectButton(true); } catch (err) { console.error("[LIFF] Fetch Health Data Error (Catch Block):", err); stepsData.innerText = "-"; hrData.innerText = "- BPM"; bmiData.innerText = "-"; updateConnectButton(false, `Fetch Error`); connectSubtext.innerText = `Error: ${err.message}`; connectSubtext.className = "text-xs text-red-500 mt-2 text-center"; hrStatus.innerHTML = `<div class="w-2 h-2 bg-red-400 rounded-full"></div><span class="text-red-500 text-sm font-medium">Error</span>`; bmiCategory.innerText = "Error"; bmiCategory.className = "text-red-500 font-medium text-sm"; } }

        function formatTime(seconds) { const mins = Math.floor(seconds / 60); const secs = seconds % 60; return `${mins}:${secs.toString().padStart(2, '0')}`; }
        function updateTimerUI() { meditationTimeLeft.innerText = formatTime(meditationTimeRemaining); const progress = ((meditationTimeTotal - meditationTimeRemaining) / meditationTimeTotal); const circumference = 2 * Math.PI * 88; meditationProgressCircle.style.strokeDashoffset = circumference * (1 - progress); if (meditationTimeRemaining <= 0) { meditationStatus.innerText = "Complete!"; } else { meditationStatus.innerText = meditationIsPlaying ? 'Meditating...' : 'Paused'; } }
        function startMeditationTimer() { if (meditationIsPlaying || meditationTimeRemaining <= 0) return; meditationIsPlaying = true; meditationStatus.innerText = 'Meditating...'; durationButtons.forEach(btn => btn.disabled = true); soundSelectButtons.forEach(btn => btn.disabled = true); breathingGuide.classList.remove('hidden'); meditationPlayIcon.classList.add('hidden'); meditationPauseIcon.classList.remove('hidden'); meditationPlayText.innerText = 'Pause'; startAudio(); meditationTimerInterval = setInterval(() => { meditationTimeRemaining--; updateTimerUI(); if (meditationTimeRemaining <= 0) { stopMeditationTimer(true); } }, 1000); }
        function stopMeditationTimer(isComplete = false) { clearInterval(meditationTimerInterval); meditationTimerInterval = null; meditationIsPlaying = false; meditationStatus.innerText = isComplete ? 'Complete!' : 'Paused'; breathingGuide.classList.add('hidden'); durationButtons.forEach(btn => btn.disabled = false); soundSelectButtons.forEach(btn => btn.disabled = false); meditationPlayIcon.classList.remove('hidden'); meditationPauseIcon.classList.add('hidden'); meditationPlayText.innerText = 'Start'; stopAudio(); if (isComplete) { if (navigator.vibrate) { console.log("[Vibrate] Timer finished, vibrating..."); navigator.vibrate(200); } else { console.log("[Vibrate] Vibration not supported."); } alert('Meditation session complete! Great job! 🧘‍♂️'); } }
        function resetMeditationTimer() { stopMeditationTimer(); meditationTimeRemaining = meditationTimeTotal; updateTimerUI(); meditationStatus.innerText = 'Ready'; durationButtons.forEach(btn => btn.disabled = false); soundSelectButtons.forEach(btn => btn.disabled = false); }
        function selectMeditationDuration(duration) { if (meditationIsPlaying) return; meditationTimeTotal = duration; meditationTimeRemaining = duration; updateTimerUI(); durationButtons.forEach(btn => { if (parseInt(btn.dataset.duration) === duration) { btn.classList.add('control-button-active'); btn.classList.remove('control-button-inactive'); } else { btn.classList.remove('control-button-active'); btn.classList.add('control-button-inactive'); } }); console.log(`[Meditation] Duration set to ${duration / 60} minutes`); }
        function selectSound(soundType) { if (meditationIsPlaying) return; selectedSoundType = soundType; soundSelectButtons.forEach(btn => { if (btn.dataset.sound === soundType) { btn.classList.add('control-button-active'); btn.classList.remove('control-button-inactive'); } else { btn.classList.remove('control-button-active'); btn.classList.add('control-button-inactive'); } }); currentAudioPlayer = audioPlayers[selectedSoundType]; console.log(`[Audio] Sound selected: ${soundType}`); }
        function initializeAudio() { if (Object.keys(audioPlayers).length > 0) return; console.log("[Audio] Initializing Tone.js Synths..."); try { 
            const song1Player = new Tone.Player({
                url: "https://cdn.pixabay.com/audio/2022/10/20/audio_f5551c6c03.mp3",
                loop: true
            }).toDestination();
            song1Player.volume.value = -10;
            audioPlayers['song1'] = song1Player;
            console.log("[Audio] Song 1 Player created.");

            const song2Player = new Tone.Player({
                url: "https://cdn.pixabay.com/audio/2024/01/24/audio_baf85f265b.mp3",
                loop: true
            }).toDestination();
            song2Player.volume.value = -10;
            audioPlayers['song2'] = song2Player;
            console.log("[Audio] Song 2 Player created.");
            
            currentAudioPlayer = audioPlayers[selectedSoundType]; updateMuteButtonUI(); } catch (e) { console.error("[Audio] Error creating Tone.js components:", e); btnAudioToggleMute.disabled = true; soundSelectButtons.forEach(btn => btn.disabled = true); } }
        async function startAudio() { if (!currentAudioPlayer) initializeAudio(); if (!audioIsPlaying && isAudioContextStarted && currentAudioPlayer) { console.log(`[Audio] Starting playback for: ${selectedSoundType}`); try { if (currentAudioPlayer.state !== 'started') { await currentAudioPlayer.start(); } audioIsPlaying = true; } catch (e) { console.error(`[Audio] Error starting player:`, e); } } else if (!isAudioContextStarted) { console.warn("[Audio] Cannot start audio - AudioContext not started by user yet."); } else if (!currentAudioPlayer) { console.error("[Audio] Cannot start audio - No player selected/initialized."); } }
        function stopAudio() { if (audioIsPlaying && currentAudioPlayer) { console.log(`[Audio] Stopping playback for: ${selectedSoundType}`); if (currentAudioPlayer.state === 'started') { currentAudioPlayer.stop(); } audioIsPlaying = false; } }
        function toggleAudioMute() { if (!isAudioContextStarted) { console.warn("[Audio] Cannot toggle mute - AudioContext not started."); return; } if (Object.keys(audioPlayers).length === 0) initializeAudio(); audioIsMuted = !audioIsMuted; Tone.Destination.mute = audioIsMuted; updateMuteButtonUI(); console.log(`[Audio] Mute toggled: ${audioIsMuted}`); }
        function updateMuteButtonUI() { if (audioIsMuted) { audioMuteIcon.classList.remove('hidden'); audioUnmuteIcon.classList.add('hidden'); } else { audioMuteIcon.classList.add('hidden'); audioUnmuteIcon.classList.remove('hidden'); } }

        async function initializeLiff() { showLoading(); console.log("[LIFF] Initializing..."); try { await liff.init({ liffId: LIFF_ID }); console.log("[LIFF] Init success!"); if (!liff.isLoggedIn()) { console.log("[LIFF] Not logged in, showing login button."); showLogin(); } else { console.log("[LIFF] Logged in, showing app."); showApp(); const profile = await liff.getProfile(); console.log("[LIFF] Profile fetched:", profile); userPicture.src = profile.pictureUrl; userPicture.onerror = () => { userPicture.src='https://placehold.co/80x80/E5E7EB/A1A1AA?text=Err'; console.warn("[LIFF] Failed to load profile picture."); }; displayName.innerText = profile.displayName; userId.innerText = profile.userId; greetingMessage.innerText = generateGreeting(profile.displayName); console.log("[LIFF] Checking URL params..."); const processedRedirect = checkUrlParams(); if (!processedRedirect) { console.log("[LIFF] Not a redirect, fetching health data..."); await fetchHealthData(profile.userId); } else { console.log("[LIFF] Processed redirect, data fetch triggered by checkUrlParams."); } } } catch (e) { console.error("[LIFF] Init Error:", e); loadingState.innerHTML = `<p class="text-lg text-red-500">LIFF Initialization Failed: ${e.message}</p>`; showLoading(); } }

        function checkUrlParams() { const params = new URLSearchParams(window.location.search); let processedParams = false; if (params.has('connect') && params.get('connect') === 'success') { console.log("[LIFF] Connect success param found."); updateConnectButton(true, "เชื่อมต่อสำเร็จ! กำลังดึงข้อมูล..."); processedParams = true; liff.getProfile().then(profile => { console.log("[LIFF] Fetching data after successful connect..."); fetchHealthData(profile.userId); }); } else if (params.has('error')) { const errorMsg = params.get('error'); console.log(`[LIFF] Connect error param found: ${errorMsg}`); updateConnectButton(false, `Connection failed: ${errorMsg}`); processedParams = true; } if (processedParams) { console.log("[LIFF] Clearing URL params."); window.history.replaceState({}, document.title, window.location.pathname); } return processedParams; }

        btnLogin.addEventListener("click", () => { console.log("[LIFF] Login button clicked."); liff.login({ redirectUri: window.location.href }); }); btnLogout.addEventListener("click", () => { if (liff.isLoggedIn()) { console.log("[LIFF] Logout button clicked."); if (confirm("คุณต้องการออกจากระบบใช่หรือไม่?")) { console.log("[LIFF] Logging out..."); liff.logout(); window.location.reload(); } else { console.log("[LIFF] Logout cancelled."); } } }); btnConnectHealth.addEventListener("click", async () => { if (btnConnectHealth.disabled) return; console.log("[LIFF] Connect Health button clicked."); btnConnectHealth.disabled = true; connectText.innerText = "Connecting..."; connectPulse.classList.add('hidden'); try { const profile = await liff.getProfile(); const lineUserId = profile.userId; const authUrl = `${SERVER_URL}/auth/google/start?line_user_id=${lineUserId}`; console.log(`[LIFF] Starting auth flow for ${lineUserId} at ${authUrl}`); if (liff.isInClient()) { console.log("[LIFF] Opening external window for auth."); alert("ระบบจะเปิดเบราว์เซอร์ภายนอกเพื่อให้คุณล็อกอิน Google..."); liff.openWindow({ url: authUrl, external: true }); } else { console.log("[LIFF] Redirecting in current window for auth."); window.location.href = authUrl; } } catch (err) { console.error("[LIFF] Error starting auth flow:", err); alert("เกิดข้อผิดพลาดในการเชื่อมต่อ: " + err.message); updateConnectButton(false, "Connection Error"); } }); btnMedication.addEventListener("click", () => { console.log("[LIFF] Medication button clicked."); openModal('medicationModal'); }); btnMeditation.addEventListener("click", async () => { console.log("[LIFF] Meditation button clicked."); if (!isAudioContextStarted && Tone.context.state !== 'running') { try { await Tone.start(); console.log('[Audio] AudioContext started by button click.'); isAudioContextStarted = true; initializeAudio(); } catch (e) { console.error("[Audio] Failed to start AudioContext:", e); alert("Could not start audio."); return; } } selectSound(selectedSoundType); selectMeditationDuration(meditationTimeTotal); openModal('meditationModal'); }); btnMeditationTogglePlay.addEventListener('click', () => { if (meditationIsPlaying) { stopMeditationTimer(); } else { if (!isAudioContextStarted) { Tone.start().then(() => { console.log('[Audio] AudioContext started by Play button.'); isAudioContextStarted = true; initializeAudio(); startMeditationTimer(); }).catch(e => console.error("[Audio] Failed to start AudioContext on Play:", e)); } else { startMeditationTimer(); } } }); btnMeditationReset.addEventListener('click', resetMeditationTimer); durationButtons.forEach(button => { button.addEventListener('click', () => { const duration = parseInt(button.dataset.duration); selectMeditationDuration(duration); }); }); soundSelectButtons.forEach(button => { button.addEventListener('click', () => { const soundType = button.dataset.sound; selectSound(soundType); }); }); btnAudioToggleMute.addEventListener('click', toggleAudioMute);

        document.addEventListener("DOMContentLoaded", initializeLiff);

    </script>
    </body>
</html>
